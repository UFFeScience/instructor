<!DOCTYPE html>
<html>
<head>
	
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="/static/pageStyle.css">
    <link rel="stylesheet" href="/static/dialogPageStyle.css">

    
    <script src="/static/haversine.js"></script>
    <script src="/static/getMinMax.js"></script>
    <script src="/static/gridCalc.js"></script>
    <script src="/static/pointInPolygon.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.16.1.min.js"></script>
    <script src="/static/windRosePlot.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.1.js"></script>

    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <script src="https://www.papaparse.com/resources/js/papaparse.js"></script> <!-- novo 11jul-->

<style>
div.space {
  line-height: 1.8;
}
div.space05 {
  line-height: 0.5;
}

</style>
</head>
<body>

<dialog id="aboutPage">
    <h2>About this tool</h2>
    <h1 style="color:rgb(92, 113, 173);">INSTRUCTOR</h1>
    <h3><u style="color:rgb(92, 113, 173);">I</u>de<u style="color:rgb(92, 113, 173);">n</u>tification of anomalous ve<u style="color:rgb(92, 113, 173);">s</u>sel 
        <u style="color:rgb(92, 113, 173);">tr</u>ajectory <u style="color:rgb(92, 113, 173);">u</u>sing <u style="color:rgb(92, 113, 173);">c</u>lus<u style="color:rgb(92, 113, 173);">t</u>ers 
        <u style="color:rgb(92, 113, 173);">o</u>f t<u style="color:rgb(92, 113, 173);">r</u>ajectories</h3>

    <p>The purpose of this academic development tool is to provide an environment for the application of algorithms
         to detect anomalous behaviors in the marine traffic.</p>

    <p>Through a visual interface the user can plot an Area of Interest (AOI) and save it for further loading. 
        After that, it is possible to generate a grid of cells to map this AOI in order to analyze vessels trajectories
        from recorded data through Automatic Information System (AIS) transmissions. </p>

    <p>Instructions for the usage of this aplication can be found in the Help menu.</p>

    <p>The source code is available to be download at GitHub.</p>

    <p>The site was developed and designed by Claudio V. Ribeiro as part of studies in his P.H.D. course.</p>

    <button onclick="fechaAboutPage();" style="display:block; margin: 0 auto; background-color: rgb(141, 163, 236);">Close</button>
</dialog>
<!--
<dialog class="dialogoAlert" id="AlertMsg">
  <div style="text-align: left;">
    <img src="/static/waiting-icon-star.gif" style="float: inline-start;" width="50" height="50">
    <h3>&nbsp; &nbsp; Please wait for the processing.</h3>
  </div>
   
  <button onclick="fechaAlertMsg();" style="display:block; margin: 0 auto; background-color: rgb(141, 163, 236);">Ok</button>
</dialog>
-->
<dialog class="dialogoAlert" id="AlertMsg">
  <div style="text-align: left;">
    <img src="/static/waiting-icon-star.gif" style="float: inline-start;" width="50" height="50">
    <h3>&nbsp; &nbsp; Please wait for the processing.</h3>
  </div>
   
  
</dialog>


<dialog class="dialogoLogin" id="loginPage">
  <div style="text-align: center;">
    <h2>Expert Identity</h2>
  </div>
  Name:<br> 
  <input type="text" id="inputTxtName" name="loginName" /><br><br>
      
  Password:<br>
  <input type="text" id="inputTxtPassword" name="password" disabled /><br><br>
  
  <button onclick="fechaLoginPage();" style="display:block; margin: 0 auto; background-color: rgb(141, 163, 236);">Login</button>
</dialog>

<dialog class="dialogo"    id="instructionsPage">
  <h2>USER INSTRUCTIONS</h2>
  <b>=== Navigation Menu ===</b><br><br>
  
  <img src="/static/navBar.gif">
  
  <p><span style="color: rgb(255, 255, 255);  background-color: black;">Map Set View</span><br>
  Selection of a zoom area to center the map
  </p>
  <span style="color: rgb(255, 255, 255);  background-color: black;">Area of Interest</span><br>
  - Load: a storaged build area will be loaded from a file (CSV format) <br>
  - Create: Build an area through the connection of location marks in the order of locations created <br>
  - Save: All the location markers will be saved in a CSV file (latlongAOI.csv) in the order of locations created.
  </p>
  <p>
    <span style="color: rgb(255, 255, 255);  background-color: black;">Grid Cell Size</span><br>
   Allow the selection of the Grid Cell Size in meters. The default value is 2000. 
  </p>

  <p><span style="color: rgb(255, 255, 255);  background-color: black;">Grid Creation</span><br>
    A Grid of Cells is built from the AOI and the selected Cell Size.</p>

  <p><span style="color: rgb(255, 255, 255);  background-color: black;">AIS Data</span><br>
      AIS data processing from a CSV file format and trajectory classification functionalities.</p>
  
  <p><span style="color: rgb(255, 255, 255);  background-color: black;">Help</span><br>
  - Instructions: To aid the user with the operation of the Vessel Trajectory Classifier Tool <br>
  - About: To present information of the development description
  </p>

  <p><b>Note:</b> The action of page refresh in the browser will perform a new start of the aplication and <br>
    all the previous interactions will be lost (e.g. location marks/polygons creation).
  </p>
  <b>======== MAP ========</b>
  <p>A set of actions are available through mouse events over the map presented:</p>
  <p>
  - Mouse click: create a new location marker<br><br>
  - Mouse double click: Over an existing location marker, the location will be excluded if it was <br>
  the last one created<br><br>
  - Mouse dragging: move the map to a new position<br><br>
  - Mouse Scrolling: up -> zoom in; down -> zoom out.
  </p>

   <button onclick="fechaInstructions();" style="display:block; margin: 0 auto; background-color: rgb(141, 163, 236);">Close</button>
</dialog>

<div class="header">
  <h1>INSTRUCTOR</h1>
</div>

<!---------------------------------------- MENU----------------------------------->

<div class="topnav" id="myTopnav">
  <div class="subnav">
    <button class="subnavbtn">Map Set View <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="centralizarMapa(3);">Africa West Coast</a>
      <a href="#" onclick="centralizarMapa(4);">Australia West Coast</a>
      <a href="#" onclick="centralizarMapa(1);">Brazil Coast</a>
      <a href="#" onclick="centralizarMapa(5);">Europe</a>
      <a href="#" onclick="centralizarMapa(2);">USA East Coast</a>

    </div>
  </div> 	
  <div class="subnav">
    <button class="subnavbtn">Area of Interest (AOI) <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="removeArea();" id="removeArea">Remove</a>
      <a href="#" onclick="select_AOI_File();" id="select_AOI_File">Select File</a>
      <a href="#" onclick="loadArea2();" id="loadAOI">Load File</a> <!--novo 12jul-->
      <a href="#" onclick="gerarPoligono();" id="geraAOI">Create</a>
      <a href="#" onclick="download_csv_file();">Save into a File</a>
      <input type="file" id="aoi_File" accept=".csv" class="not-visible" /> <!--novo 11jul-->
    </div>
  </div>
    
  <div class="subnav">
    <button class="subnavbtn">Grid Cell Size <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="setSizeCell(100);">100m </a>
      <a href="#" onclick="setSizeCell(200);">200m </a>
      <a href="#" onclick="setSizeCell(300);">300m </a>
      <a href="#" onclick="setSizeCell(500);">500m </a>
      <a href="#" onclick="setSizeCell(1000);">1Km </a>
      <a href="#" onclick="setSizeCell(2000);">*2Km </a>
      <a href="#" onclick="setSizeCell(5000);">5Km </a>
    </div>
  </div>

  <div class="subnav">
    <button class="subnavbtn" onclick="gridCreation();">Grid Creation </button>
  </div>

  <div class="subnav">
    <button class="subnavbtn">Trajectory Data <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="enable_AIS_File_btn();">Start Clustering</a>
      
      <a href="#" onclick="concat_AIS_Files();" id="concat_Files">Build File</a>
      
      <a href="#" onclick="downloadClassificationFile();" id="downloadClassification">Download Classifications</a>
    </div>
  </div>


  <div class="subnav">
    <button class="subnavbtn">Help <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="exibeInstructions();">Instructions</a>
      <a href="#" onclick="exibeAboutPage();" id="showAboutPage">About</a>
    </div>
  </div>
</div>
<!-------*******************  PANELS *************************************-------->
<div class="row">
  <div class="leftcolumn">
    <div class="card">
      <h3>MAP</h3>
      <div id="mapa" style="width: 100.0%; height: 670px;"></div>
    </div>
  </div>
  <div class="rightcolumn">
    <div class="card" id="cardSuperior" style="width: 100.0%; height:345px;">
      
      <div id="aisData">
        <fieldset id="aisDataPanel" class="visible" >
          <legend>Historical Trajectories - AIS Data Clustering</legend>
            <div class="space">
              <div>    
                
                <button type="button" id="btnSelectAIS_File" disabled onclick="selectAIS_File();">Select File</button>
                <input type="text" id="inputTxtFileName" name="Name" disabled/>
                <button id="btnPlot" onclick="aisPlotFile();" disabled>Plot</button>&nbsp;
                <!--
                <br>
                -->
                <label for="clustering">Clustering:</label>
                    <select id="clustering" disabled onchange="GetSelectedClusteringValue(this)">
                        <option value="1">None (Density plots only)</option>
                        <option value="2">Agglomerative Clustering</option>
                        <option value="3">BIRCH</option>
                        <option value="4">DBSCAN (Lat, Long)</option>
                        <option value="5">DBSCAN (Lat, Long, Speed)</option>
                        <option value="6">HDBSCAN</option>
                        <option value="7">K-Means</option>
                        <option value="8">Mean Shift</option>
                        <option value="9">Mini-Batch K-Means</option>
                        <option value="10">Mixture of Gaussians</option>
                        <option value="11">OPTICS</option>
                        <option value="12">Spectral Clustering</option>
                        <option value="13">K-Means Ensemble</option>
                        <option value="14">Ensemble Clustering</option>
                    
                    </select>
                    <!--
                    Parameters:
                    <label for="checkBox_Auto"></label> 
                    <input type="checkbox" id="checkBox_Auto" onclick="checkBox_Auto_Function()">
                    suggested<br>
                    -->
                    <fieldset id="parametersPanel" class="visible">  <!-- style="width:265px" -->
                      <legend>Clustering Parameters</legend>    
                        <label id="lbl_inputParameter1">-- No parameters --</label>
                        <input type="text" id="inputParameter1" disabled value="0" class="not-visible" name="parameter1" size="2"/>&nbsp;
                      
                        <label id="lbl_inputParameter2"></label>
                        <input type="text" id="inputParameter2" disabled value="0" class="not-visible" name="parameter2" size="2"/>&nbsp;
                      
                        <label id="lbl_inputParameter3"></label>
                        <input type="text" id="inputParameter3" disabled value="0" class="not-visible" name="parameter3" size="2"/>&nbsp;
                      
                        <button type="button" id="btnApply" onclick="applyClustering();" disabled>Apply</button>
                                   
                    </fieldset>  
              </div>
            </div>
        </fieldset>
      </div> 
      <br>
      <div id="trajectory">
        <fieldset id="trajectoryPanel" class="visible">
              <legend>New Trajectories - AIS Data Analysis</legend>
                  <div class="space">
                    
                    <button type="button" id="btnLoadDatasets_File" onclick="selectDatasetFile();" disabled>Select Dataset </button>
                    <input type="text" id="inputDataSetsFileName" name="datasetsName" disabled/>
                    <button id="btnLoadDataset" onclick="loadDatasetFile();" disabled>Load</button>&nbsp;&nbsp;&nbsp;
                    <!--
                    <br>
                    -->
                    <label for="listBoxTrajectories">Trajectory:</label>
                    <select id="listBoxTrajectories" disabled>
                        <!--<option value="0" selected>Select</option> 
                        <option value="traj1">traj1</option>
                        <option value="traj2">traj2</option>
                        <option value="traj3">traj3</option> -->
                    </select>&nbsp;&nbsp;
                    
                    <button type="button" id="btnShow" onclick="showTrajectory();" disabled>Show </button>
                  </div> 
                  <div class="space05">
                    <br>
                  </div>  
            <!-- alt-->
            <div class="row">
              <div class="leftPanel">
                
                <fieldset id="classificationPanel" disabled class="visible">  <!-- style="width:265px" -->
                  <legend>Classification</legend>     
                          <input type="radio" id="btnSelectNormal" name="btnRadioNormal" value="normal" checked />
                          <label for="btnSelectNormal">Normal</label>
                  
                          <input type="radio" id="btnSelectAnomalous" name="btnRadioNormal" value="anomalous" />
                          <label for="btnSelectAnomalous">Anomalous</label> &nbsp; &nbsp;
                          <br><br>
                          <label for="confidence">Confidence:</label>
                          <select id="confidence">
                              <option value="very low" >Very low</option>
                              <option value="low"      >Low</option>
                              <option value="medium"   >Medium</option>
                              <option value="high"     >High</option>
                              <option value="very high">Very high</option>
                          </select>&nbsp; &nbsp;
                          <button id="btnSaveClassif"  onclick="btnClassifAnomaly();">Save</button>
                          
                </fieldset>
              </div>
              <!--
              <div class="rightPanel">
                <br><br>
                <button type="button" id="btnFinish" onclick="finishTrajectoryAnalysis();" style="background-color: rgb(141, 163, 236);"disabled>Finish</button>
              </div>
              -->
            </div>  
        </fieldset>  
      </div>  
      
    </div>

    <div class="card" id="cardInferior" >
      <div id="aisPlotPanel" style="width: 100.0%; height:350px;" class="visible">
      </div>
      
      <div id="AISpointGridPanel" class="not-visible"> 
        <fieldset id="AISpointPanel">
          <legend>AIS Selected Point from Trajectory</legend>
              Course: 
              <input type="text" id="inputTxtCourse" name="Course" size="6" disabled/>
              Speed: 
              <input type="text" id="inputTxtSpeed" name="Speed" size="4" disabled/>
              <button id="btnPrevious" onclick="btnPrevious()" disabled>Previous</button>
              <button id="btnNext" onclick="btnNext()" disabled>Next</button>
              <br>
        </fieldset>
      </div>
      
      <div id="windRosePanel" class="not-visible">
        <div class="row">
          <div class="leftSubColumn">
            <div id="vesselsSpeed" style="width: 100.0%; height:330px;">
            </div>
          </div>
          <div class="rightSubColumn"> 

                
                <div style="text-align: left;">
                  <font size="-1">
                    Speed<br>
                    <span style="color: red;    background-color: rgb(255,0,0);">X</span> 20+<br>
                    <span style="color: orange; background-color: orange;">X</span> 15-20<br>
                    <span style="color: yellow; background-color: #FFFF00;">X</span> 11-15<br>
                    <span style="color: green;  background-color: green;">X</span> 7-11<br>
                    <span style="color: blue;   background-color: blue;">X</span> 3-7<br>
                    <span style="color: gray;   background-color: gray;">X</span> 0-3<br>
                  </font> 
                </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  <p>&copy; Instructor 2022-2023 &nbsp;&nbsp; Claudio V. Ribeiro</p>
</div>

<!------------------------  SCRIPT ---------------------------------------->

<script>
  var latInfGrid, latSupGrid, lonInfGrid, lonSupGrid, latMedGrid;
  var expertID;
  var expertPassword;
  var expertFileName;
  var polygon_CSV
  //const modal = document.querySelector("dialog");  //funciona
  const modalAbout = document.getElementById("aboutPage");
  const modalLogin = document.getElementById("loginPage"); 
  const modalInstructions = document.getElementById("instructionsPage");
  const modalAlert = document.getElementById("AlertMsg");

  console.log("distancia = ", getDistanceFromLatLng(30, -90, 31, -90));
  cellSize = 2000 ; //valor default
  var vertA_Cel, vertB_Cel, vertC_Cel, vertD_Cel;
  var vertices;
  
  var qtdeCel_X, qtdeCel_Y, larguraCelula, alturaCelula;
  var polygon;
  var polylinha; 
  var flagPolygon = false;
  var flagGridCreation = false; 
  let pontos = [[0.0,0.0][0.0,0.0]]    
	
	pontos.pop()
    	
	var mapa = L.map('mapa').setView([-14,-38], 4);
  L.control.scale().addTo(mapa);

	var tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(mapa);

  var mapaAIS = L.map('aisPlotPanel').setView([-14,-38], 4);
  L.control.scale().addTo(mapaAIS);

	var tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(mapaAIS);

  var markersLayerGroup = new L.LayerGroup(); 
  markersLayerGroup.addTo(mapa); 

  var cellsLayerGroup = new L.LayerGroup(); 
  cellsLayerGroup.addTo(mapa); 

  var trajectoryLayerGroup = new L.LayerGroup(); 
  trajectoryLayerGroup.addTo(mapa); 
  var displayedPointsLayerGroup = new L.LayerGroup(); 
  displayedPointsLayerGroup.addTo(mapa); 

  var legendLayerGroup = new L.LayerGroup(); 
  legendLayerGroup.addTo(mapa); 

  var pathHistoricalFileAISdata = ""; 
  var pathDatasetFile = ""; 
  var ais_Historical_AOI_ArrayFiltered = []; 
  var ais_Trajectory_AOI_ArrayFiltered = [];
  var trajectoryPointIndex = 0;
  let trajetoriaArray = [];
  var totalTraj = 0;
  var aisAOI_trajSelected = [];
  var gridCell_array = [];
  var flagLegendExist = false; 
    
  var global_df_ClusterColorTable = []; 
  var perc_pointsNotMatch = 0.0; 
  var df_ClusterTotalMatch = [];

  var firstShowAboutPage_flag = true;
  var flag_active_back_end_process = false;  //////////// novo 19jul
  exibeAboutPage();
  
    //////////////////////////////////// FUNCTIONS ////////////////////////////////

  function GetSelectedClusteringValue(clustering) {
    var selText = clustering.options[clustering.selectedIndex].innerHTML;
    var selIndex = clustering.value;
        
    var labelParam1 = ""
    var labelParam2 = ""
    var labelParam3 = ""
    
    switch(selIndex) {
      case "1":  // None (Density plots only)
        //labelParam1 = "-- No parameters --";
        show_Parameters_labels_inputs(false, false, false, "", 0, "", 0, "", 0 )
        break;

      case "2": // Agglomerative Clustering
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "3": //BIRCH
        labelParam1 = "Threshold:";
        labelParam2 = "n_clusters:";
        show_Parameters_labels_inputs(true, true, false, labelParam1, 0.1, labelParam2, 18, "", 0)
        break;

      case "4": // DBSCAN LAT, LON
      case "5": // DBSCAN LAT, LON, SPEED
        labelParam1 = "eps:";
        labelParam2 = "Min Pts:";
        show_Parameters_labels_inputs(true, true, false, labelParam1, 0.04, labelParam2, 18, "", 0)
        break;

      case "6": //HDBSCAN
        labelParam1 = "eps:";
        labelParam2 = "min_samples:";
        labelParam3 = "min_cluster_size:";
        show_Parameters_labels_inputs(true, true, true, labelParam1, 0.04, labelParam2, 18, labelParam3, 20)
        break;

      case "7":  // K-Means
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "8": // Mean Shift
        labelParam1 = "Bandwidth:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 1, "", 0, "", 0)
        break;

      case "9": // Mini-Batch K-Means
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "10": //Mixture of Gaussians
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "11": // OPTICS
        labelParam1 = "eps:";
        labelParam2 = "min_samples:";
        show_Parameters_labels_inputs(true, true, false, labelParam1, 0.04, labelParam2, 18, "", 0)
        break;

      case "12": // Spectral Clustering
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "13": //KMeans Ensemble
        labelParam1 = "n_Kmeans:";
        labelParam2 = "Min_Probability:";
        labelParam3 = "n_clusters:";
        show_Parameters_labels_inputs(true, true, true, labelParam1, 16, labelParam2, 0.6, labelParam3, 18)
        break;

      case "14": // Ensemble Clusters
        labelParam1 = "n_Kmeans:";
        labelParam2 = "n_clusters:";
        show_Parameters_labels_inputs(true, true, false, labelParam1, 16, labelParam2, 18, "", 0)
        break;
      
      default:
        // code block
    } 

  }

  function show_Parameters_labels_inputs(p1, p2, p3, label_P1, value_P1, label_P2, value_P2, label_P3, value_P3){
    
    var labelParameter1 = document.getElementById("lbl_inputParameter1");
    var labelParameter2 = document.getElementById("lbl_inputParameter2");
    var labelParameter3 = document.getElementById("lbl_inputParameter3");

    var value_inputParameter1 = $('#inputParameter1');
    var value_inputParameter2 = $('#inputParameter2');
    var value_inputParameter3 = $('#inputParameter3');

    if (p3){
      labelParameter3.innerHTML = label_P3;
      $("#inputParameter3").removeClass("not-visible");
      $("#inputParameter3").addClass("visible");
      value_inputParameter3.val(value_P3);

    } else{
      labelParameter3.innerHTML = "";
      $("#inputParameter3").removeClass("visible");
      $("#inputParameter3").addClass("not-visible");
    }
    if (p2){
      labelParameter2.innerHTML = label_P2;
      $("#inputParameter2").removeClass("not-visible");
      $("#inputParameter2").addClass("visible");
      value_inputParameter2.val(value_P2);
    } else{
      labelParameter2.innerHTML = "";
      $("#inputParameter2").removeClass("visible");
      $("#inputParameter2").addClass("not-visible");
    }
    if (p1){
      labelParameter1.innerHTML = label_P1
      $("#inputParameter1").removeClass("not-visible");
      $("#inputParameter1").addClass("visible");
      value_inputParameter1.val(value_P1);
    } else{
      labelParameter1.innerHTML = "";
      $("#inputParameter1").removeClass("visible");
      $("#inputParameter1").addClass("not-visible");
    }
    if (!(p1 || p2 || p3)){
      labelParameter1.innerHTML = "-- No parameters --"
    }
  }

  function newMarker(e){
    //var new_mark = L.marker().setLatLng(e.latlng).addTo(mapa);
    var new_mark;
    //new_mark = L.marker().setLatLng(e.latlng).addTo(mapa);
    new_mark = new L.marker().setLatLng(e.latlng).addTo(mapa);
    new_mark.addTo(markersLayerGroup); 
    mapa.addLayer(markersLayerGroup); 

    new_mark.dragging.disable();//enable
    new_mark.on('dblclick', function(e){ 
    //  console.log(e.target);
        var latUltPonto = pontos[pontos.length - 1][0];
        var lonUltPonto = pontos[pontos.length - 1][1]; 
        console.log(latUltPonto,lonUltPonto);
        if ((latUltPonto == e.latlng.lat.toFixed(5)) && (lonUltPonto == e.latlng.lng.toFixed(5))){
          mapa.removeLayer(new_mark);//(e.target);
          pontos.pop();
        };
    })
    var lat = e.latlng.lat.toFixed(5), lng = e.latlng.lng.toFixed(5);
    new_mark.bindPopup("Latitude: " + lat + "</br>" + "Longitude: "+ lng);
		console.log(lat, lng);
		pontos.push([lat, lng]);
		//console.table(pontos);
		new_mark.on('dragend', function(e) {  //precisa habilitar o dragging
		       new_mark.bindPopup("Latitude: " + lat + "</br>"+ "Longitude: "+ lng) // 
        });

		//valida conteudo do input 
    if (pontos.length > 2) {
          //habilita o botão
          //  document.getElementById("geraAOI").disabled = false;
          //  document.getElementById("salvaCoordAOI").disabled = false;
    } else {
              //desabilita o botão se o conteúdo do input ficar em branco
          //  document.getElementById("geraAOI").disabled = true;
          //  document.getElementById("salvaCoordAOI").disabled = false;
    };
	};
  mapa.on('click', newMarker);	    	

	function gerarPoligono(){
		if (pontos.length > 2) {
      if (flagPolygon == true){
        mapa.removeLayer(polygon);
        flagPolygon = false;
      };
      polygon = L.polygon(pontos, {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
              ).addTo(mapa);
          console.table(pontos);
      mapa.removeLayer(markersLayerGroup);
      flagPolygon = true;
    }
    else {
      if (flagPolygon == true){
        mapa.removeLayer(polygon);
        flagPolygon = false;
      };
      alert("To create a polygon it would have at least three locations in the map.")
    };  
  }
		
	function centralizarMapa(local){
    
    var localZoom = local;
    if (localZoom == 1){
      mapa.setView([-14, -38], 4);
    }
    if (localZoom == 2){
      mapa.setView([39, -73], 4);
    }
		if (localZoom == 3){
      mapa.setView([3, 5], 4);
    }
    if (localZoom == 4){
      mapa.setView([-24, 112], 4);
    }
    if (localZoom == 5){
      mapa.setView([45, 0], 4);
    }
  };
  function removeArea(){
    if (flagPolygon == true){
      mapa.removeLayer(markersLayerGroup); 
      markersLayerGroup.clearLayers();
      while (pontos.length) { //remove all the elements inside the array
        pontos.pop(); 
      }
      mapa.removeLayer(polygon);
      flagPolygon = false;
      
      if (flagGridCreation == true){
          mapa.removeLayer(cellsLayerGroup);
          cellsLayerGroup.clearLayers(); //recente
          flagGridCreation = false;
      }
    } else {
      alert("There is no area to be removed.")
    }
  }
  
  function select_AOI_File(){

    var AOI_File = document.getElementById("aoi_File");
    AOI_File.click();
    //retorno = AOI_File.click();
    //console.log("retorno do AOI_File.click = ",retorno);
    
  }

  function loadArea2(){

    //var AOI_File = document.getElementById("aoi_File");
    //AOI_File.click();

    var fileSize = 0;
    var theFile = document.getElementById("aoi_File");
    //theFile.click();
    var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
    //var data_CSV = new array;
    if (regex.test(theFile.value.toLowerCase())) {  //check if file is CSV
     
        if (typeof (FileReader) != "undefined") { //check if browser support FileReader
        
          var myReader = new FileReader(); // file reader object
          myReader.onload = function(e) {  //get file contents, split them by line
              
              let data = myReader.result.split("\n");
              for (let i in data) { //loop each row split them by "," and save it in array
                data[i] = data[i].split(",");
              }
              data.shift(); // remove first element - the header
              data.pop(); // remove last element - blank array
              console.log(data);
              plotLoadedArea(data);
              //return data; // teste
              
          }
          myReader.readAsText(theFile.files[0]);  //call file reader onload
        }
        else {
           alert("This browser does not support HTML5.");
        }
    }
    else {
           alert("Please upload a valid CSV file.");
    }
    //console.log(data);
    return false;    //plotLoadedArea(data2);
  }


  function loadArea(){
    //loadArea2(); // novo 11jul
    //alert("parada no comando loadArea"); //
    $.ajax({
            url: "{{ url_for('loadFileAOI') }}",
            type: "GET",
            dataType: 'json',
            success: plotLoadedArea,
            error: function(){
              alert("erro execução loadFileAOI no Back-end");
            }
            
        });
  }
  function plotLoadedArea(locations){
    //pontos = locations;
    if (locations == "") {
      return;
    }
    
    if (flagPolygon == true){
      removeArea();
    }
    console.log("locations 0 = ",locations[0]); //
    //pontos = JSON.parse(locations); //novo 12jul
    pontos = locations.map(function (obj){
      return obj;
    }); //novo 12 jul
    console.log("locations from back end = ", pontos); // novo 11jul
    var csv = 'LAT,LONG\n';  
          
    //merge the data with CSV  
    pontos.forEach(function(row) {  
            csv += row.join(',');  
            csv += "\n";  
    });  
    polygon_CSV = csv;
    console.log("polygon_CSV = ", polygon_CSV);

    const [latInfAOI, latSupAOI, lonInfAOI, lonSupAOI, latMedAOI] = findMinMax(pontos);
    gerarPoligono();
    mapa.setView([latMedAOI, (lonInfAOI + lonSupAOI)/2], 8);
  }
   //create a user-defined function to download CSV file   
  function download_csv_file() {  
    console.log("locations pontos dentro da funcao downloag = ", pontos); // novo 12jul
    if (pontos.length > 2) {
        //define the heading for each row of the data  
        var csv = 'LAT,LONG\n';  
          
        //merge the data with CSV  
        pontos.forEach(function(row) {  
                csv += row.join(',');  
                csv += "\n";  
        });  
        polygon_CSV = csv;
        //display the created CSV data on the web browser
        //document.write(csv);  
        var hiddenElement = document.createElement('a');  
        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);  
        hiddenElement.target = '_blank';  
          
        //provide the name for the CSV file to be downloaded  
        hiddenElement.download = 'LatLongAOI.csv';  
        hiddenElement.click(); 
        
    } else {alert("It would have at least three locations in the map to save these.")}; 

  }
  function excluirUltPonto(){
      //  console.log(e.target);
      var latUltPonto = pontos[pontos.length - 1][0];
      var lonUltPonto = pontos[pontos.length - 1][1]; 
      console.log(latUltPonto,lonUltPonto);
      //if ((latUltPonto == e.latlng.lat.toFixed(5)) && (lonUltPonto == e.latlng.lng.toFixed(5))){
       //       mapa.removeLayer(e.target);
          //    pontos.pop();
      //};
      //mapa.removeLayer(polygon);
  }
  function setSizeCell(size){
    cellSize = size;
    console.log("cell size = ", cellSize);
  }  
  function gridCreation(){
    exibeAlertMsg();
    alert("The Grid construction takes a few seconds depending on the area size");
    
    if (flagPolygon == true){
        
        const [latInfAOI, latSupAOI, lonInfAOI, lonSupAOI, latMedAOI] = findMinMax(pontos);
        latInfGrid = latInfAOI; 
        latSupGrid = latSupAOI;
        lonInfGrid = lonInfAOI;
        lonSupGrid = lonSupAOI;
        console.log("clique possível no botao grid Creation");
        console.log("AOI pontos = ", latInfAOI, latSupAOI, lonInfAOI, lonSupAOI, latMedAOI);
        var pontoA = [latInfAOI, lonInfAOI];
        var pontoB = [latSupAOI, lonInfAOI];
        var pontoC = [latSupAOI, lonSupAOI];
        var pontoD = [latInfAOI, lonSupAOI];
        var coordGrid = [pontoA, pontoB, pontoC, pontoD, pontoA];

        if (flagGridCreation == true){
          mapa.removeLayer(markersLayerGroup);
          mapa.removeLayer(cellsLayerGroup);
          cellsLayerGroup.clearLayers(); 
          mapa.removeLayer(polylinha); 
          flagGridCreation = false;
        }
        
        exibirAreaLimGrid(coordGrid);
        
        [qtdeCel_X, qtdeCel_Y, larguraCelula, alturaCelula] = calculaGridParametros(latInfAOI, latMedAOI, latSupAOI, lonInfAOI, lonSupAOI, cellSize);
        for (var j = 0; j < qtdeCel_Y; j++) {
          for (var k = 0; k < qtdeCel_X; k++) {   
              
            vertA_Cel = [parseFloat(latInfAOI + j * alturaCelula)      ,parseFloat(lonInfAOI + k * larguraCelula)];
            vertB_Cel = [parseFloat(latInfAOI + (j + 1) * alturaCelula),parseFloat(lonInfAOI + k * larguraCelula)];
            vertC_Cel = [parseFloat(latInfAOI + (j + 1) * alturaCelula),parseFloat(lonInfAOI + (k + 1)* larguraCelula)];
            vertD_Cel = [parseFloat(latInfAOI + j * alturaCelula)      ,parseFloat(lonInfAOI + (k + 1)* larguraCelula)];
            vertices  = [vertA_Cel, vertB_Cel, vertC_Cel, vertD_Cel];
            if (isPointInPolygon(vertA_Cel[0],vertA_Cel[1], pontos) ||
                isPointInPolygon(vertB_Cel[0],vertB_Cel[1], pontos) ||
                isPointInPolygon(vertC_Cel[0],vertC_Cel[1], pontos) ||
                isPointInPolygon(vertD_Cel[0],vertD_Cel[1], pontos)){
              //polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "green", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
              //).addTo(mapa);
              polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "green", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
              ).addTo(cellsLayerGroup);
            }
            else {
              //polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "gray", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "black", "fillOpacity": 0.5, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
              //).addTo(mapa);
              polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "gray", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "black", "fillOpacity": 0.5, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
              ).addTo(cellsLayerGroup);
            }
          }  
        }   
        
        mapa.addLayer(cellsLayerGroup); 
        flagGridCreation = true;
    } else {
      alert("To create a Grid it would have an Area of Interest.")};
      fechaAlertMsg();
  }  
  function exibirAreaLimGrid(pontosGrid){
       
    polylinha = L.polyline(pontosGrid, {"bubblingMouseEvents": true, "color": "blue", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
                    ).addTo(mapa);
  }
  function enable_AIS_File_btn(){

    if (flagGridCreation == true){
      var btn = document.getElementById("btnSelectAIS_File");
      btn.disabled = false;  
    }
    else {
      alert("It must have a Grid created.")
    }
  }

  function btnClassifAnomaly(){
    saveClassificationFile();
  }
  
  function performPost() {
        $.ajax({
            type: "POST",
            url: "{{ url_for('create_file') }}",
            data: {"name" : "Jim"},
        })
    }
  
  function exibeAlertMsg(){
    flag_active_back_end_process = false; ////novo 19jul
    modalAlert.showModal()
  }
  function fechaAlertMsg(){
    flag_active_back_end_process = true; ////novo 19jul
    modalAlert.close()
  }
  
  function exibeAboutPage(){
    modalAbout.showModal()
  }
  function fechaAboutPage(){
    modalAbout.close()
    if (firstShowAboutPage_flag == true){
      exibeLoginPage();
    }
    firstShowAboutPage_flag = false;
  }

  function exibeLoginPage(){
    modalLogin.showModal();
  }
  function fechaLoginPage(){
    
    expertID = document.getElementById("inputTxtName").value;
    expertPassword = document.getElementById("inputTxtPassword").value;
    var dado = JSON.stringify(expertID);
    
    console.log("nome do expert = ", expertID);
    $.ajax({
            url: "{{ url_for('checkLoginName') }}",
            type: "POST",
            dataType: 'json',
            contentType: 'application/json',
            data: dado,
            success: validaLogin,
            error: function(){
              alert("erro execução login no Back-end");
            }
        });
  }
  function validaLogin(retorno){

    expertFileName = retorno;
    console.log("depois do ajax - expertFileName = ", expertFileName);
    
    if (expertFileName == 'none') {
      console.log("valor none");
      alert("The name, password or both are unknown. Please try again.");
    } else {
      modalLogin.close();
    }
  }
  function loadExpertFile(){
    $.ajax({
            url: "{{ url_for('loadExpertFile') }}",
            type: "GET",
            dataType: 'json',
            success: function(retorno){ 
              //alert("Arquivo de classificação carregado");
            },
            error: function(){
              alert("error execution loadExpertFile no back-end");
            }
    });
  }

  function saveClassificationFile(){

    const d = new Date();
    let strDate = d.toLocaleDateString();
    let strTime = d.toLocaleTimeString();
    
    var typeTraj = ""
    var trajetoria = document.getElementById("listBoxTrajectories").value;
    var clustering = document.getElementById("clustering").value;
    
    var confidence = document.getElementById("confidence").value;
    var normalState  = document.getElementById("btnSelectNormal");
    if (normalState.checked){
        typeTraj = "normal"
    } else {
        typeTraj = "anomalous"
    }

    var dados = JSON.stringify([trajetoria, clustering, typeTraj, confidence,strDate,strTime]);
    console.log("dados do post saveClassification = ", dados);
    
    $.ajax({
            url: "{{ url_for('saveClassification') }}",
            type: "POST",
            dataType: 'json',
            contentType: 'application/json',
            data: dados,
            success: function(retorno){ 
              alert("Arquivo de classificação salvo");
            },
            error: function(){
              alert("error execution saveClassification no back-end");
            }
    });
  
  }
  
  function exibeInstructions(){
    modalInstructions.showModal()
  }
  function fechaInstructions(){
    modalInstructions.close()
  }
  function selectAIS_File(){
    $.ajax({
            url: "{{ url_for('selectAIS_File') }}",
            type: "GET",
            dataType: 'json',
            success: openFileAIS,
            error: function(){
              alert("error execution selection AIS File");
            }
    });
  }

  function openFileAIS(retorno){
    
    console.log("retorno = ", retorno);
    
    var textField = $('#inputTxtFileName');
    textField.disabled = false;

    
    //textField.val(retorno); novo 13jul
    textField.val("data/AOI Delaware 08-05-23 Grid 2k.csv");

    //pathHistoricalFileAISdata = retorno; // novo 13jul
    pathHistoricalFileAISdata = "data/AOI Delaware 08-05-23 Grid 2k.csv"

    var btn = document.getElementById("btnPlot");
    btn.disabled = false;
  }
 
  function AISplotPanel(){
    
    var dados = JSON.stringify([latInfGrid, latSupGrid, lonInfGrid, lonSupGrid,
                                pathHistoricalFileAISdata, polygon_CSV, larguraCelula, alturaCelula, qtdeCel_X]);
    console.log("front variável dados = ", dados);
    $.ajax({
      url: "{{ url_for('openHistoricalFileAndFilterAOI') }}",
      type: "POST",
      dataType: 'json',
      contentType: 'application/json',
      data: dados,
      success: plotAisDataPanel,
      error: function(){
        fechaAlertMsg();
        alert("erro execução Post para Open File");
      }
    });
    ////////////////////// novo 19jul

  }

  function plotAisDataPanel(retorno){
    
    console.log(retorno);
    var ret = JSON.parse(retorno[0]); 
    gridCell_array = JSON.parse(retorno[1]); 
    
    var len = ret.length;
    
    if (len > 0){
      mapa.removeLayer(markersLayerGroup); 
      mapa.removeLayer(cellsLayerGroup);
      
      flagGridCreation = false;
      
      for (var i = 0; i < len; i++) {
        
          ais_Historical_AOI_ArrayFiltered.push(ret[i]);

          var circle = L.circle([ret[i][2], ret[i][3]], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 30
          }).addTo(mapaAIS);
      }  
      fechaAlertMsg(); 
      alert("The plotting processing has been done."); 
      var btn = document.getElementById("clustering");
      btn.disabled = false;
      
      btn = document.getElementById("inputParameter1");
      btn.disabled = false;
      btn = document.getElementById("inputParameter2");
      btn.disabled = false;
      btn = document.getElementById("inputParameter3"); // novo 25Jun23
      btn.disabled = false;

      btn = document.getElementById("btnApply");
      btn.disabled = false;

    } else {
      alert("arquivo selecionado não possui dados de AIS no Grid/AOI selecionada");
    } 
    console.log("tamanho aisAOI_Array = ", ais_Historical_AOI_ArrayFiltered.length);
    console.log(ais_Historical_AOI_ArrayFiltered);
    fechaAlertMsg(); //////////////// novo 19jul
  }

  function aisPlotFile(){
    alert("This action may be extended for one or more minutes after closing this message. At the end another message will inform the status.");  
    exibeAlertMsg();
    $("#windRosePanel").removeClass("visible");
    $("#windRosePanel").addClass("not-visible");
    $("#aisPlotPanel").removeClass("not-visible");
    $("#aisPlotPanel").addClass("visible");

    polygon = L.polygon(pontos, {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
                    ).addTo(mapaAIS);
    const [latInfAOI, latSupAOI, lonInfAOI, lonSupAOI, latMedAOI] = findMinMax(pontos);
    
    mapaAIS.setView([latMedAOI, (lonInfAOI + lonSupAOI)/2], 6);
    AISplotPanel();
  }

  function enableTrajectoryPanel(){
   
    var btn = document.getElementById("listBoxTrajectories");
    btn.disabled = false;
    btn = document.getElementById("btnPrevious");
    btn.disabled = false;
    btn = document.getElementById("btnNext");
    btn.disabled = false;
    
    loadExpertFile();
  }
  function classificationWindow(){
   
    var btn = document.getElementById("classificationPanel");
    btn.disabled = false;
    //btn = document.getElementById("btnFinish"); novo 29Jun
    //btn.disabled = false;
    
    $("#aisPlotPanel").removeClass("visible");
    $("#aisPlotPanel").addClass("not-visible");
    
    $("#AISpointGridPanel").removeClass("not-visible"); 
    $("#AISpointGridPanel").addClass("visible");

    $("#windRosePanel").removeClass("not-visible");
    $("#windRosePanel").addClass("visible");
  }
  function applyClustering(){
    
    var listBoxClustering = document.getElementById("clustering");
    idClustering = parseInt(listBoxClustering.value);
    
    var param1 = document.getElementById("inputParameter1").value;
    var param2 = document.getElementById("inputParameter2").value;
    var param3 = document.getElementById("inputParameter3").value; // novo 25Jun
    var dados = JSON.stringify([idClustering, latInfGrid, latSupGrid, lonInfGrid, lonSupGrid, param1, param2, param3]);
    
    console.log("front variável dados = ", dados);
    console.log("Clustering = ", idClustering);

    var len = ais_Historical_AOI_ArrayFiltered.length;
    if (len == 0){
      alert("Botao apply - arquivo selecionado não possui dados de AIS no Grid/AOI selecionada");
      return;
    }  
    exibeAlertMsg(); 
    //seleciona o clustering
    if (idClustering == 1){
      applyNoneClustering(len);
      fechaAlertMsg(); // novo 4Jul
    } else {
      $.ajax({
        url: "{{ url_for('applyClustering') }}",
        type: "POST",
        dataType: 'json',
        contentType: 'application/json',
        data: dados,
        success: plot_Clustering_LatLon,
        error: function(){
          fechaAlertMsg();
          alert("erro execução Post para applyClustering");
        }
      });
    }
    enableTrajectoryPanel();
    console.log("passou no ajax applyClustering");
    //while (flag_active_back_end_process == true) {
    //  console.log("Waiting for back-end process to finish");
    //}
  }
  function applyNoneClustering(length){

    for (var i = 0; i < length; i++) {
      
      var circle = L.circle([ais_Historical_AOI_ArrayFiltered[i][2], ais_Historical_AOI_ArrayFiltered[i][3]], {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5,
        radius: 50
      }).addTo(mapa);
    } 
  }
  
  function plot_Clustering_LatLon(retorno){
    console.log(retorno);
    console.log("passou no success - plot_Clustering");
    var df_Clusters_LatLon = JSON.parse(retorno[0]); 
    var df_ClusterColorTable  = JSON.parse(retorno[1]); 

    lenGlobal = df_ClusterColorTable.length;
    while (global_df_ClusterColorTable.length) { //remove all the elements inside the array
      global_df_ClusterColorTable.pop(); 
    }
    for (index=0; index < lenGlobal; index++){
      global_df_ClusterColorTable.push(df_ClusterColorTable[index]); // make a global copy
    }

    var len = df_Clusters_LatLon.length;
    var clusterColor = "";
    var numCluster = 0;
    var opacity_value = 0.5;  // default value

    if (len > 0){
      mapa.removeLayer(markersLayerGroup); 
      mapa.removeLayer(cellsLayerGroup);
      
      for (var i = 0; i < len; i++) {
     
          numCluster = parseInt(df_Clusters_LatLon[i][7]); 
        
          if (numCluster == -1){
            clusterColor = '#000000';
            opacity_value = 1;
          } else{
            clusterColor = df_ClusterColorTable[numCluster][1];
            opacity_value = 0.5;
          }
          
          var circle = L.circle([df_Clusters_LatLon[i][1], df_Clusters_LatLon[i][2]], {
            color: clusterColor,
            fillColor: clusterColor,//'#f03',
            fillOpacity: opacity_value,
            radius: 30
          }).addTo(mapa);
      }  
      fechaAlertMsg(); 
      alert("The Clustering plotting processing has been done."); 
      var btn = document.getElementById("btnLoadDatasets_File");
      btn.disabled = false;
      
    } else {
      alert("erro na execução plotDBSCAN_LAT-LON");
    } 
    console.log("tamanho df_Clusters_LatLon = ", df_Clusters_LatLon.length);
    console.log(df_Clusters_LatLon);


  }

  function showTrajectory(){
    
    var listBoxTraj = document.getElementById("listBoxTrajectories");
    idTrajetory = listBoxTraj.value;
    //var count_idTrajetory = 1; //concluir contagem
    len = ais_Trajectory_AOI_ArrayFiltered.length;

    while (aisAOI_trajSelected.length) { //remove all the elements inside the array
      aisAOI_trajSelected.pop(); 
    }
    
    for (index=0; index < len; index++){

      //if (count_idTrajetory <= idTrajetory){
        if (idTrajetory == ais_Trajectory_AOI_ArrayFiltered[index][20]){
          aisAOI_trajSelected.push(ais_Trajectory_AOI_ArrayFiltered[index]);
        }

      //}
    }
    console.log("tamanho do aisAOI-trajSelected = ", aisAOI_trajSelected.length);
    console.log("aisAOI_trajSelected conteudo = ", aisAOI_trajSelected);
    //plotSelectedTrajectory();  // novo 29Jun
    classificationWindow();
    plotSelectedTrajectory(); // novo 29Jun
    trajectoryPointIndex = 0
    drawGridCell(trajectoryPointIndex); // show the first AIS point of the trajectory
    displayMapLegend(); 
  }
  function plotSelectedTrajectory(){

    var len = aisAOI_trajSelected.length;
    if (len > 0){
      
      mapa.removeLayer(trajectoryLayerGroup); 
      trajectoryLayerGroup.clearLayers();
      mapa.removeLayer(displayedPointsLayerGroup); 
      displayedPointsLayerGroup.clearLayers();

      for (var i = 0; i < len; i++) {
        
          var circle = L.circle([aisAOI_trajSelected[i][2], aisAOI_trajSelected[i][3]], {
            color: 'yellow',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 50
          }).addTo(trajectoryLayerGroup) 
        
      }  
      mapa.addLayer(trajectoryLayerGroup); 
    }
  }
  
  function drawGridCell(index){
    
    mapa.removeLayer(polygonCell); 
    
    var lat  = aisAOI_trajSelected[index][2];
    var long = aisAOI_trajSelected[index][3];
    var circle = L.circle([lat, long], {color: 'blue', fillColor: '#f03', fillOpacity: 0.5, radius: 50
          }).addTo(displayedPointsLayerGroup); 
    mapa.addLayer(displayedPointsLayerGroup); 
    vertices = calcVerticesCell(lat, long, latInfGrid, lonInfGrid, larguraCelula, alturaCelula); 
    polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "blue", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
                  ).addTo(mapa);

    var textFieldSpeed = $('#inputTxtSpeed');
    textFieldSpeed.disabled = false;
    textFieldSpeed.val(aisAOI_trajSelected[index][4]);
    var bg = document.getElementById("inputTxtSpeed");
    bg.style.color = "green"; // CORRIGIR
    
    var cardinalLetter = aisAOI_trajSelected[index][19]; 
    var gridCellNumber = aisAOI_trajSelected[index][21];
    
    var textFieldCourse = $('#inputTxtCourse');
    textFieldCourse.disabled = false;
    textFieldCourse.val(aisAOI_trajSelected[index][5] + " " + cardinalLetter);
    console.log("MMSI = ", aisAOI_trajSelected[index][0], " Course = ", aisAOI_trajSelected[index][5],
     " Heading = ", aisAOI_trajSelected[index][6], " Cell = ", gridCellNumber);

    // windrose data
    const [s3_array, s7_array, s11_array, s15_array, s20_array, s99_array] = buildWindRose_array(gridCellNumber);
    exibeWindRose(s3_array, s7_array, s11_array, s15_array, s20_array, s99_array); 
  }
  function buildWindRose_array(gridCellID){
    //gridCell_array
    var s3  = [0, 0, 0, 0, 0, 0, 0, 0];
    var s7  = [0, 0, 0, 0, 0, 0, 0, 0];
    var s11 = [0, 0, 0, 0, 0, 0, 0, 0];
    var s15 = [0, 0, 0, 0, 0, 0, 0, 0];
    var s20 = [0, 0, 0, 0, 0, 0, 0, 0];
    var s99 = [0, 0, 0, 0, 0, 0, 0, 0];
    var index = 0;
    var speedBIN = 0;
    var freq = "";

    var len = gridCell_array.length;
    for (index = 0; index < len; index++) {
      if (gridCellID == gridCell_array[index][0]){
        break;
      }
    }
    for (; index < len; index++) {
      if (gridCellID == gridCell_array[index][0]){
        
        courseBIN_number = parseInt(gridCell_array[index][1].charAt(0));
        speedBIN = gridCell_array[index][2];
        freq = gridCell_array[index][3];

        if (speedBIN == 3){
          s3[courseBIN_number] = freq;
        }
        if (speedBIN == 7){
          s7[courseBIN_number] = freq;
        }
        if (speedBIN == 11){
          s11[courseBIN_number] = freq;
        }
        if (speedBIN == 15){
          s15[courseBIN_number] = freq;
        }
        if (speedBIN == 20){
          s20[courseBIN_number] = freq;
        }
        if (speedBIN == 99){
          s99[courseBIN_number] = freq;
        }
      }else {
        break;
      }
    }
    console.log ("windRose arrays = \n", s3, "\n", s7, "\n", s11, "\n", s15, "\n", s20, "\n",s99);
    return [s3, s7, s11, s15, s20, s99];
  }

  function btnPrevious(){
    if (trajectoryPointIndex > 0){
      trajectoryPointIndex = trajectoryPointIndex - 1;
      drawGridCell(trajectoryPointIndex);
    }
  }

  function btnNext(){
    if (trajectoryPointIndex < aisAOI_trajSelected.length -1){
      trajectoryPointIndex = trajectoryPointIndex + 1;
      //displayedPointsLayerGroup.removeLayer(circle); nao testado
      drawGridCell(trajectoryPointIndex);
    } 
  }
  function selectDatasetFile(){
    $.ajax({
            url: "{{ url_for('selectDatasetFile') }}",
            type: "GET",
            dataType: 'json',
            success: openDatasetFile,
            error: function(){
              alert("error execution selection AIS File");
            }
    });
  }

  function openDatasetFile(retorno){
    ////////////// novo 13jul
    retorno = "data/AOI Delaware 09-05-23 Grid 2k.csv";
    //console.log(retorno);
    if (retorno == ""){
      return;
    }

    var textField = $('#inputDataSetsFileName');
    textField.disabled = false;

    //textField.val(retorno); novo 13jul
    textField.val("data/AOI Delaware 09-05-23 Grid 2k.csv");
    
    //pathDatasetFile = retorno; // novo 13jul
    pathDatasetFile = "data/AOI Delaware 09-05-23 Grid 2k.csv";
    
    var btn = document.getElementById("btnLoadDataset");
    btn.disabled = false;
  }
  
  function loadDatasetFile(){
    alert("This action may be extended for one or more minutes after closing this message. At the end another message will inform the status.");  
    exibeAlertMsg(); 
    
    var dados = JSON.stringify([latInfGrid, latSupGrid, lonInfGrid, lonSupGrid,
                                pathDatasetFile, polygon_CSV, larguraCelula, alturaCelula, qtdeCel_X]);
    console.log("front variável dados = ", dados);
    $.ajax({
      url: "{{ url_for('openTrajectoryFileAndFilterAOI') }}",
      type: "POST",
      dataType: 'json',
      contentType: 'application/json',
      data: dados,
      success: getArrayData_forTrajectories,
      error: function(){
        fechaAlertMsg();
        alert("erro execução Post para Open Dataset File");
        
      }
    });
  }
  function getArrayData_forTrajectories(retorno){
    console.log(retorno);
    var ret = JSON.parse(retorno[0]); 
    totalTraj = JSON.parse(retorno[1]); 
    console.log("total de traj = ", totalTraj);
    
    var len = ret.length;
    
    if (len > 0){
            
      for (var i = 0; i < len; i++) {
        ais_Trajectory_AOI_ArrayFiltered.push(ret[i]);
      }  
      loadSelectBoxTrajectories(totalTraj);
      fechaAlertMsg();
      alert("The AIS data processing has been done."); 
      
    } else {
      fechaAlertMsg();
      alert("arquivo selecionado não possui dados de AIS no Grid/AOI selecionada");
    } 
    console.log("tamanho aisAOI_Array = ", ais_Trajectory_AOI_ArrayFiltered.length);
    console.log(ais_Trajectory_AOI_ArrayFiltered);
    
    btn = document.getElementById("btnShow"); // novo 21Mai
    btn.disabled = false;
  }

  function downloadClassificationFile(){
    $.ajax({
            url: "{{ url_for('downloadClassification') }}",
            type: "GET",
            //dataType: 'json',
            success: function(retorno){ 
              if (retorno != ""){
                alert("Download finished");
              } else {alert("Download Canceled by the user.")}
            },
            error: function(){
              alert("error execution downloadClassification in the back-end");
            }
    });

  }
  function loadSelectBoxTrajectories(total_traj) {
    var listBoxTraj = document.getElementById("listBoxTrajectories");
        
    for  (var k = 1; k <= total_traj; k++){ 
        var option = document.createElement("option");
        option.text = k;
        console.log("option text = ", option.text);
        listBoxTraj.add(option);
    }
  }
  ///// Map Legend
  function displayMapLegend(){
    exibeAlertMsg(); ///novo 16jul
    //alert("The Matching Cells calculation has been started.");//
    var colorCluster = "";
    var percentage = 0;
    var idCluster = 0;
    //const myTimeout = setTimeout(get_PercentageMatchCells, 5000);// novo 16jul
    get_PercentageMatchCells();
    exibeAlertMsg(); ///novo 16jul
    ///////////////////////////////////////////////////
    //setTimeout(() => {
            //console.log("Hi, I am the console.log inside setTimeout 2sec")
        //},
        //2000
    //);
    
    /////////// sleep //////
    //let currentTime = Date.now() / 1000;
    //let expectedTime = currentTime + 2;
    //while (currentTime < expectedTime) {
        //currentTime = Date.now() / 1000;
    //}
    /////////// fim sleep
    alert("The Matching Cells calculation has been started.");
    //////////////////////////////////////////////////////////////////

    /*Legend specific*/
    if (flagLegendExist == true){
      mapa.removeControl(legend);///////
    }
    legend = L.control({ position: "topright" }); 

    legend.onAdd = function(mapa) {
      var div = L.DomUtil.create("div", "legend");
      
      div.innerHTML += "<h4>Matching Cells</br>Trajectory x Cluster</h4>";
      
      console.log("df_ClusterTotalMatch.length = ", df_ClusterTotalMatch.length);
      console.log("perc_pointsNotMatch = ", perc_pointsNotMatch);

      for (var i=0; i < df_ClusterTotalMatch.length; i++){
        
        //colorCluster = global_df_ClusterColorTable[i][1];
        percentage = df_ClusterTotalMatch[i][2];
        idCluster = df_ClusterTotalMatch[i][0];
        
        if (percentage != 0 && idCluster != -1 ){ 
          colorCluster = global_df_ClusterColorTable[idCluster][1];
                    
          console.log("percentage = ", percentage);
          console.log("colorCluster = ", colorCluster);

          div.innerHTML += '<i style="background:' + colorCluster + '; width:' +
            parseInt(percentage*2) + 'px"></i>' + '(' + idCluster + ') ' + percentage + '%</br>';
            
        }
      }
      div.innerHTML += '<i style="background: #FFFFFF; width:' +
            parseInt(perc_pointsNotMatch*2) + 'px"></i>Not Match ' + perc_pointsNotMatch + '%</br>';

      div.innerHTML += "(Black dots are not clustered points)";
      //div.innerHTML += '<i style="background: #477AC2; width:100px"></i>50%</br>';
      //div.innerHTML += '<i style="background: #ffffff; width:60px"></i>30% Not Match';
      return div;
    };

    
    legend.addTo(mapa); 
    flagLegendExist = true;
    alert("The Matching Cells calculation has been done.");
    fechaAlertMsg(); // novo 16Jul
  }
  
  function get_PercentageMatchCells(){
    console.log("js Tamanho aisAOI_trajSelected = ", aisAOI_trajSelected.length)
    var dado = JSON.stringify(aisAOI_trajSelected);
        
    $.ajax({
            url: "{{ url_for('calc_ClusterMatch') }}",
            type: "POST",
            dataType: 'json',
            contentType: 'application/json',
            data: dado,
            timeout: 5000, // novo 16jul
            success: get_PercentageMatch,
            error: function(xhr, textStatus, errorThrown) { //novo 16jul
              if (textStatus == 'timeout') {
                  alert("Error : Timeout for calc_ClusterMatch call!");
              } else{
                  alert("erro execução get_PercentageMatchCells function");
              }
            }
            //error: function(){
             // alert("erro execução get_PercentageMatchCells function");
            //}
        });
  }
  function get_PercentageMatch(retorno){

    perc_pointsNotMatch  = JSON.parse(retorno[0]);
    df_ClusterTotalMatch = JSON.parse(retorno[1]);
    console.log("perc_pointsNotMatch = ", perc_pointsNotMatch);
    console.log("df_ClusterTotalMatch = \n", df_ClusterTotalMatch);
  
  }
  
  function concat_AIS_Files(){

    if (flagGridCreation == false){
      alert("It must have a Grid created.");
      return;
    }
    //jQuery.ajaxSetup({async:false}); // novo 04Jul
    exibeAlertMsg(); // novo 04Jul

    var dados = JSON.stringify([latInfGrid, latSupGrid, lonInfGrid, lonSupGrid,
                                polygon_CSV, larguraCelula, alturaCelula, qtdeCel_X]);
    console.log("front variável dados = ", dados);
    $.ajax({
      url: "{{ url_for('concat_AIS_Files') }}",
      type: "POST",
      dataType: 'json',
      contentType: 'application/json',
      data: dados,
      success: function(){
        alert("Ais Files concatenation has been done successfull");},
      error: function(){
        alert("error AIS Files concatenation");
      }
    });
    //jQuery.ajaxSetup({async:true}); // novo 04jul
    fechaAlertMsg(); // novo 4Jul
  }
  function checkBox_Auto_Function() {
  var checkBox = document.getElementById("checkBox_Auto");
  //var text = document.getElementById("text");
  if (checkBox.checked == true){
    //text.style.display = "block";
  } else {
     //text.style.display = "none";
  }
}

</script>

</body>
</html>
