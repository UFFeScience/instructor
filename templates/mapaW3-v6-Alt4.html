<!DOCTYPE html>
<html>
<head>
	
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="/static/pageStyle.css">
    <link rel="stylesheet" href="/static/dialogPageStyle.css">
        
    <script src="/static/haversine.js"></script>
    <script src="/static/getMinMax.js"></script>
    <script src="/static/gridCalc.js"></script>
    <script src="/static/pointInPolygon.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.16.1.min.js"></script>
    <script src="/static/windRosePlot.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.1.js"></script>

    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <script src="https://www.papaparse.com/resources/js/papaparse.js"></script> <!-- novo 11jul-->

<style>
div.space {
  line-height: 2.0;
}
div.space18 {
  line-height: 1.8;
}
div.space12 {
  line-height: 1.2;
}

div.space08 {
  line-height: 0.8;
}

div.space05 {
  line-height: 0.5;
}

</style>
</head>
<body>

<dialog id="aboutPage">
    <h2>About this tool</h2>
    <h1 style="color:rgb(92, 113, 173);">INSTRUCTOR</h1>
    <h3><u style="color:rgb(92, 113, 173);">I</u>de<u style="color:rgb(92, 113, 173);">n</u>tification of anomalous ve<u style="color:rgb(92, 113, 173);">s</u>sel 
        <u style="color:rgb(92, 113, 173);">tr</u>ajectory <u style="color:rgb(92, 113, 173);">u</u>sing <u style="color:rgb(92, 113, 173);">c</u>lus<u style="color:rgb(92, 113, 173);">t</u>ers 
        <u style="color:rgb(92, 113, 173);">o</u>f t<u style="color:rgb(92, 113, 173);">r</u>ajectories</h3>

    <p>The purpose of this academic development tool is to provide an environment for the application of algorithms
         to detect anomalous behaviors in the marine traffic.</p>

    <p>Through a visual interface the user can plot an Area of Interest (AOI) and save it for further loading. 
        After that, it is possible to generate a grid of cells to map this AOI in order to analyze vessels trajectories
        from recorded data through Automatic Information System (AIS) transmissions. </p>

    <p>Instructions for the usage of this aplication can be found in the Help menu.</p>

    <p>The source code is available to be download at GitHub.</p>

    <p>The site was developed and designed by Claudio V. Ribeiro as part of studies in his P.H.D. course.</p>

    <button onclick="fechaAboutPage();" autofocus style="display:block; margin: 0 auto; background-color: rgb(141, 163, 236);">Close</button>
</dialog>

<dialog class="dialogoInfo" id="Info_Msg">
  <div style="text-align: left;">
    <h2>Login Sucessfull!</h2><br>
    <h2>The <span style="color: #e71d89; background-color: black;">highlighted</span> 
       itens indicate the next action available/recomended to be executed.</h2>
    <!-- -->
    <button onclick="fechaInfo_Msg();" autofocus style="display:block; margin: 0 auto; background-color: rgb(141, 163, 236);"> Ok </button>
  </div>
</dialog>

<dialog class="dialogoInfo" id="Restart_Confirmation_Msg">
  <div style="text-align: center;">
    <h2>This action will restart the page.<br>Do you confirm it?</h2><br>
        <!-- -->
    <button type="button" onclick="restart_app();" style="background-color: rgb(141, 163, 236); text-align: center;"> Yes </button>&nbsp;&nbsp;&nbsp;&nbsp;
    <button type="button" onclick="close_restart_page();" autofocus style="background-color: rgb(141, 163, 236); text-align: center;"> No </button>
  </div>
</dialog>


<dialog class="dialogoAlert" id="AlertMsg">
  <div style="text-align: left;">
    <img src="/static/waiting-icon-star.gif" style="float: inline-start;" width="50" height="50">
    <h3>&nbsp; &nbsp; Please wait for the processing.</h3>
  </div>
</dialog>

<dialog class="dialogoLogin" id="loginPage">
  <div style="text-align: center;">
    <h2>Expert Identity</h2>
  </div>
  Name:<br> 
  <input type="text" id="inputTxtName" name="loginName" /><br><br>
      
  Password:<br>
  <input type="password" id="inputTxtPassword" name="password" /><br><br>
  
  <button id="btn_fechaLogin" onclick="fechaLoginPage();" style="display:block; margin: 0 auto; background-color: rgb(141, 163, 236);">Login</button>
</dialog>

<dialog class="dialogo"    id="instructionsPage">
  <div style="text-align: center;" >
    <h2>USER INSTRUCTIONS</h2>
    <b>=== Navigation Menu ===</b><br><br>
    
    <p><span style="color: rgb(134, 31, 31);  background-color: rgb(255, 255, 255); ">Map Set View</span></p>
    <img src="/static/submenu-Map.png" width="600" height="80" ><br>
  </div>
    <ul>
      <li>Selection of a zoom area to center the map.</li>
    </ul>
  <div style="text-align: center;"> 
    <span style="color: rgb(134, 31, 31);  background-color: rgb(255, 255, 255);">Area of Interest</span><br><br>
          <img src="/static/submenu-AOI.png" width="400" height="80"><br>
  </div>
    <ul>
      <li> Remove: a created or loaded area will be excluded.</li>
      <li> Load File: a built and storaged area will be loaded from a file (CSV format).</li>
      <li> Create: Build an area through the connection of location marks in the order of locations created.</li>
      <li> Save into a File: All the location markers will be saved in a CSV file (latlongAOI.csv) in the order of locations created.</li>
    </ul>

  <div style="text-align: center;">
      <span style="color: rgb(134, 31, 31);  background-color: rgb(255, 255, 255);">Grid Creation (Cell Size)</span><br><br>
          <img src="/static/submenu-Grid.png" width="400" height="80"> <br><br>
  </div>
    <ul>
      <li>Allow the selection of the Grid Cell Size in meters. Then a Grid of Cells is automatic built from the current AOI.
    </ul>

  <div style="text-align: center;">
    <p><span style="color: rgb(134, 31, 31);  background-color: rgb(255, 255, 255);">Trajectory Processing</span></p><br>
          <img src="/static/submenu-TrajData.png" width="550" height="80"><br>
  </div>
    <ul>
      <li>Initial Phase: This item enables the side panel to start with the loading of a file which contains historical AIS data.</li>
      <li>Clustering: In this item a dialog box is open to select a file which contains the results of a clustering algorithm execution
          of a historical AIS datafile.</li>
      <li>Preprocessing: A dialog box is open to select a AIS file data which would be filtered to collect only the data concernig the AOI. 
        At the end another dialog box will ask for a filename to save this filtered data. This is a preliminary activity to start the Initial Phase.</li>
      <li>Concatenation: After the execution a number of File Preprocessing actions, a dialog box will allow the selection of multiple files to
         concatenate in order to have a higher volume of data inside a unique file. This is also a preliminary activity to start the Initial Phase.</li> 
    </ul>
  <div style="text-align: center;">
    <p><span style="color: rgb(134, 31, 31);  background-color: rgb(255, 255, 255);">Help</span></p><br>
          <img src="/static/submenu-Help.png"><br>
  </div>
    <ul>
      <li>Instructions: To aid the user with the operation of the INSTRUCTOR Tool.</li>
      <li>About: To present information concerning the purpose and references of the INSTRUCTOR development.</li>
    </ul>

    <p><b>Note:</b> The action of page refresh in the browser will perform a new start of the aplication and
      all the previous interactions will be lost (e.g. location marks, polygons creation, clustering and trajectory activities).
    </p>
  <div style="text-align: center;">
    <b>======== MAP ========</b>
    <p>A set of actions are available through mouse events over the map presented:</p>
  </div>
    <ul> 
      <li>Mouse click: create a new location marker.</li>
      <li>Mouse double click: Over an existing location marker, the location will be excluded if it was
        the last one created.</li>
      <li>Mouse dragging: move the map to a new position.</li>
      <li>Mouse Scrolling: up -> zoom in; down -> zoom out.</li>
    </ul>
  <br>
  <div style="text-align: center;">
    <b>======== SIDE PANELS ========</b>
  </div>
  <!--
  <img src="/static/xxxx.png"> 
  -->
    <br>
    <button onclick="fechaInstructions();" style="display:block; margin: 0 auto; background-color: rgb(141, 163, 236);">Close</button>
</dialog>

<div class="header">
  <h1>INSTRUCTOR</h1>
</div>

<!---------------------------------------- MENU----------------------------------->

<div class="topnav" id="myTopnav">
  <div class="subnav" id="subnav_menu_item">
    <button class="subnavbtn" id="btn_Map_Set_View" >Map Set View <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="centralizarMapa(3);">Africa West Coast</a>
      <a href="#" onclick="centralizarMapa(4);">Australia West Coast</a>
      <a href="#" onclick="centralizarMapa(1);">Brazil Coast</a>
      <a href="#" onclick="centralizarMapa(5);">Europe</a>
      <a href="#" onclick="centralizarMapa(2);">USA East Coast</a>

    </div>
  </div> 	
  <div class="subnav">
    <button class="subnavbtn" id="btn_AOI" >Area of Interest (AOI) <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="removeArea();" id="removeArea" >Remove</a>
      <a href="#" onclick="select_AOI_File();" id="select_AOI_File">Load File</a>
      <a href="#" onclick="gerarPoligono();" id="geraAOI">Create</a>
      <a href="#" onclick="download_csv_file();" id="saveAOI" >Save into a File</a>
      <input type="file" id="aoi_File" accept=".csv" class="not-visible" /> <!--novo 11jul-->
    </div>
  </div>
    
  <div class="subnav">
    <button class="subnavbtn" id="btn_Grid_Creation" >Grid Creation (Cell Size) <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="setSizeCell(100);">100m </a>
      <a href="#" onclick="setSizeCell(200);">200m </a>
      <a href="#" onclick="setSizeCell(300);">300m </a>
      <a href="#" onclick="setSizeCell(500);">500m </a>
      <a href="#" onclick="setSizeCell(1000);">1Km </a>
      <a href="#" onclick="setSizeCell(2000);">2Km </a>
      <a href="#" onclick="setSizeCell(5000);">5Km </a>
    </div>
  </div>
 
  <div class="subnav">
    <button class="subnavbtn" id="btn_Trajectory_Data">Trajectory Processing <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="enable_AIS_File_btn();" id="subButton_enable_AIS_File" >Initial Phase</a>
      <!--
      <a href="#" onclick="recover_clustering_btn();" id="subButton_recover_clustering" >Recover Clustering</a>
      -->
      <a href="#" onclick="file_AIS_select_dialog();" id="id_filter_AOI_from_AIS_file">File Preprocessing</a>
      <a href="#" onclick="concat_AIS_Files_v2();" id="concat_Files" >Files Concatenation</a>
      <input type="file" id="id_filter_AOI" accept=".csv" class="not-visible" /> <!--novo 29 ago-->
      <input type="file" id="id_concat_filtered_files" accept=".csv" multiple class="not-visible" /> <!--novo 01 set-->
    </div>
  </div>
  
  <div class="subnav">
    <button class="subnavbtn" id="btn_Help">Help <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#" onclick="exibeInstructions();">Instructions</a>
      <a href="#" onclick="exibeAboutPage();" id="showAboutPage">About</a>
    </div>
  </div>
</div>
<!-------*******************  PANELS *************************************-------->
<div class="row">
  <div class="leftcolumn">
    <div class="card">
      <h3>MAP</h3>
      <div id="mapa" style="width: 100.0%; height: 670px;">
      </div>
      
    </div>
  </div>
  <div class="rightcolumn">
    <div class="card" id="cardSuperior" style="width: 100.0%; height:180px;">
      <div id="aisData" style="opacity: 0.4;"> <!-- 02 Ago -->
        <div class="space08">
          <span style="font-weight:bold;">Historical Trajectories - AIS Data Clustering</span><br><br>
        </div>
        <!--
        <fieldset id="aisDataPanel" class="visible" >
          
          <legend>Historical Trajectories - AIS Data Clustering</legend>
        -->    
            <div class="space18">
              <div>    
                <button type="button" id="btnSelectAIS_File" disabled onclick="selectAIS_File();">Load File</button>
                <!-- 
                <button type="button" id="btnSelectAIS_File_TESTE" onclick="async_selectAIS_File_NEW();">TESTE</button>
                -->
                <input type="text" id="inputTxtFileName" name="Name" disabled/>&nbsp;&nbsp;
                <button id="btn_apply_filter_vessels" onclick="apply_vessels_filter();" >Apply Filters</button>&nbsp;
                
                <button id="btnPlot" onclick="aisPlotFile();" disabled>Plot</button><br> <!-- altered 03 set -->
                <!--03 set -->
                <input type="file" id="inputFile_load_filtered_historical_AIS" name="load_historical_file" accept=".csv" class="not-visible" /> 
                <!--  03 set 
                <form method=post action = "/success" enctype=multipart/form-data>
                  <input type="file" id="inputFile_historical_AIS" multiple name="historical_file" accept=".csv" class="not-visible" /> 
                  <input type="submit" value="Upload">
                </form>
              -->
                 <!---->
                <fieldset id="parametersPanel" class="visible">  <!-- style="width:265px" -->
                  <legend>Clustering Algorithm & Parameters</legend>
                    <input type="checkbox" id="btn_chk_recover" name="btn_chk_recover" onchange="btn_chk_recover_select();" />
                    <button type="button" id="btn_recover_clustering" onclick="recover_clustering();">Recover</button>&nbsp;

                    <label for="clustering">Algorithm:</label>
                    <select id="clustering" disabled onchange="GetSelectedClusteringValue(this)">
                        <!--<option value="1">None (Density plots only)</option>-->
                        <option value="1">Automatic Mode</option>
                        <option value="2">Agglomerative Clustering</option>
                        <option value="3">BIRCH</option>
                        <option value="4">DBSCAN (Lat, Long)</option>
                        <option value="5">DBSCAN (Lat, Long, Speed)</option>
                        <option value="6">HDBSCAN</option>
                        <option value="7">K-Means</option>
                        <option value="8">Mean Shift</option>
                        <option value="9">Mini-Batch K-Means</option>
                        <option value="10">Mixture of Gaussians</option>
                        <option value="11">OPTICS</option>
                        <option value="12">Spectral Clustering</option>
                        <option value="13">K-Means Ensemble</option>
                        <option value="14">Ensemble Clustering</option>
                    </select>
                    
                    <button type="button" id="btnApply" onclick="async_applyClustering();" disabled>Run</button>
                    <!--03 set -->
                    <input type="file" id="inputFile_load_filtered_historical_AIS_and_clustering" name="load_historical_file_and_clustering" accept=".csv" class="not-visible" /> 
                    <!--  03 set -->
                    <br>
                    <label id="lbl_inputParameter1">Auto settings for an Ensemble Clustering</label>
                    <input type="text" id="inputParameter1" disabled value="0" class="not-visible" name="parameter1" size="2"/>&nbsp;
                  
                    <label id="lbl_inputParameter2"></label>
                    <input type="text" id="inputParameter2" disabled value="0" class="not-visible" name="parameter2" size="2"/>&nbsp;
                  
                    <label id="lbl_inputParameter3"></label>
                    <input type="text" id="inputParameter3" disabled value="0" class="not-visible" name="parameter3" size="2"/>&nbsp;
                  
                    
                    <button type="button" id="btn_save_clustering" onclick="save_clustering();" >Save</button>
                                
                </fieldset>  
              </div>
            </div>
        <!--</fieldset>-->
      </div> 
      <br>
    </div>
    <div class="card" id="cardCentral" style="width: 100.0%; height:200px;">

      <div id="trajectory" style="opacity: 0.4;"> <!-- 02 Ago -->
        <div class="space08">
          <span style="font-weight:bold;">New Trajectories - AIS Data Analysis</span><br><br>
        </div>
        <!--
        <fieldset id="trajectoryPanel" class="visible">
              <legend>New Trajectories - AIS Data Analysis</legend>
        -->
                  <div class="space">
                    <button type="button" id="btnLoadDatasets_File" onclick="async_selectDatasetFile();" disabled>Select Dataset </button>
                    <input type="text" id="inputDataSetsFileName" name="datasetsName" disabled/>&nbsp;&nbsp;
                    <button id="btnLoadDataset" onclick="async_loadDatasetFile();" disabled>Load</button>
                    <br>
                    <label for="listBoxTrajectories">Trajectory:</label>
                    <select id="listBoxTrajectories" disabled>
                    </select>&nbsp;&nbsp;
                    
                    <button type="button" id="btnShow" onclick="async_showTrajectory();" disabled>Plot &#x27F3</button>&nbsp;&nbsp;&nbsp;
                    <button type="button" id="btnPlay_trajectory" onclick="play_trajectory();" disabled>Play</button>
                    <button type="button" id="btnStop_Play_trajectory" onclick="stop_play_trajectory();" disabled>Stop</button>&nbsp;&nbsp;&nbsp;
                    <button type="button" id="btnShow_panel_matching_cells" onclick="show_panel_matching_cells();" disabled>Statistics</button>
                    <!--10 set -->
                    <input type="file" id="inputFile_load_filtered_trajectory_AIS" name="load_trajectory_file" accept=".csv" class="not-visible" /> 
                    <!--10 set -->

                  </div> 
                  <div class="space05">
                    <br>
                  </div>  
            <!-- alt-->
            <div class="row">
              <div class="leftPanel">
                <div class="space05">
                  <fieldset id="classificationPanel" disabled class="visible">  <!-- style="width:265px" -->
                    <legend>Classification</legend>     
                            <input type="radio" id="btnSelectNormal" name="btnRadioNormal" onchange="btnRadioNormal_select();" value="normal" checked />
                            <label for="btnSelectNormal">Normal</label>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;

                            <label for="confidence">Confidence:</label>
                            <select id="confidence">
                                <option value="very low" >Very low</option>
                                <option value="low"      >Low</option>
                                <option value="medium"   >Medium</option>
                                <option value="high"     >High</option>
                                <option value="very high">Very high</option>
                            </select>&nbsp; 
                            
                            <button id="btnSaveClassif"  onclick="btnClassifAnomaly();">Classify</button><br><br>
                            <input type="radio" id="btnSelectAnomalous" name="btnRadioNormal" onchange="btnRadioAnomalous_select();" value="anomalous" />
                            <label for="btnSelectAnomalous">Anomalous</label> &nbsp;
                            
                            <label for="anomalous_type" >Type:</label>
                            <select id="anomalous_type" disabled>
                                <option value="unusual speed"    >unusual speed</option>
                                <option value="unusual course"   >unusual course</option>
                                <option value="U-turn"           >U-turn</option>
                                <option value="Prohibit Area"    >Prohibit Area</option>
                                <option value="Poor Optimization">Poor Optimization</option>
                            </select>&nbsp;

                            <button id="btnExport"  onclick="download_classifications();">Export</button><br>

                  </fieldset>
                </div>
              </div>
              
              <div class="rightPanel" style="float: left;">
                &nbsp; 
                <!--
                <button type="button" id="btnFinish" onclick="finishTrajectoryAnalysis();" style="background-color: rgb(141, 163, 236);"disabled>Finish</button>
                -->
              </div>
              
            </div>  
        <!--</fieldset>  -->
      </div>  
      
    <!--</div>-->
  </div>
    <div class="card" id="cardInferior" style="width: 100.0%; height:350px; "> <!-- 02 ago -->
      <!--
      <div id="aisPlotPanel" style="width: 100.0%; height:350px;" class="visible">
      </div>  
      -->
      <div id="windRosePanel" class="visible" style="opacity: 0.4;"> <!--original not-visible--> <!-- 02 ago -->
        <div style="width: 70.0%; height:15px;">
          <span style="font-weight:bold;">AIS Data (Course & Speed)</span>
        </div>

        <div class="row">
          <div class="leftSubColumn">
            <div id="vesselsSpeed" style="width: 100.0%; height:325px;">
            </div>
          </div>
          <div class="rightSubColumn"> 
                <div style="text-align: left;">
                  <font size="-1">
                    Speed<br>
                    <span style="color: red;    background-color: rgb(255,0,0);">X</span> 20+<br>
                    <span style="color: orange; background-color: orange;">X</span> 15-20<br>
                    <span style="color: yellow; background-color: #FFFF00;">X</span> 11-15<br>
                    <span style="color: green;  background-color: green;">X</span> 7-11<br>
                    <span style="color: blue;   background-color: blue;">X</span> 3-7<br>
                    <span style="color: gray;   background-color: gray;">X</span> 0-3<br>
                  </font> 
                </div><br>
                <div id="AISpointGridPanel" class="visible" style="opacity: 0.4;"> 
                  <fieldset id="AISpointPanel">
                    <legend>Trajectory Point</legend>
                        Course: 
                        <input type="text" id="inputTxtCourse" name="Course" size="6" disabled/><br>
                        Speed: 
                        <input type="text" id="inputTxtSpeed" name="Speed" size="4" disabled/><br>
                        <button id="btnPrevious" onclick="btnPrevious()" disabled>Previous</button>
                        <button id="btnNext" onclick="btnNext()" disabled>Next</button>
                        <br>
                  </fieldset>
                </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  <p>&copy; Instructor 2022-2023 &nbsp;&nbsp; Claudio V. Ribeiro</p>
</div>

<!--*********************************************************************-->
<!--                           SCRIPT                                    -->
<!--*********************************************************************-->

<script>
  var latInfGrid, latSupGrid, lonInfGrid, lonSupGrid, latMedGrid;
  var expertID;
  var expertPassword;
  var expertFileName;
  var polygon_CSV
  //const modal = document.querySelector("dialog");  //funciona
  const modalAbout = document.getElementById("aboutPage");
  const modalLogin = document.getElementById("loginPage"); 
  const modalInfo = document.getElementById("Info_Msg"); // 03 ago
  const modalInstructions = document.getElementById("instructionsPage");
  const modalAlert = document.getElementById("AlertMsg");
  const modalRestart = document.getElementById("Restart_Confirmation_Msg");

  //console.log("distancia = ", getDistanceFromLatLng(30, -90, 31, -90));
  cellSize = 2000 ; //valor default
  var vertA_Cel, vertB_Cel, vertC_Cel, vertD_Cel;
  var vertices;
  
  var qtdeCel_X, qtdeCel_Y, larguraCelula, alturaCelula;
  var polygon;
  var polylinha; 
  var flagPolygon = false;
  var flagGridCreation = false; 
  let pontos = [[0.0,0.0][0.0,0.0]];
	
	pontos.pop();
    	
	//var mapa = L.map('mapa').setView([-14,-38], 4);
  var mapa = L.map('mapa').setView([30,-20], 3);
  L.control.scale().addTo(mapa);

	var tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19, minZoom: 2, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(mapa);

  var markersLayerGroup = new L.LayerGroup(); 
  markersLayerGroup.addTo(mapa); 

  var cellsLayerGroup = new L.LayerGroup(); 
  cellsLayerGroup.addTo(mapa); 

  var trajectoryLayerGroup = new L.LayerGroup(); 
  trajectoryLayerGroup.addTo(mapa); 
  var displayedPointsLayerGroup = new L.LayerGroup(); 
  displayedPointsLayerGroup.addTo(mapa); 

  var legendLayerGroup = new L.LayerGroup(); 
  legendLayerGroup.addTo(mapa); 

  var pathHistoricalFileAISdata = ""; 
  var pathDatasetFile = ""; 
  var ais_Historical_AOI_ArrayFiltered = []; 
  var ais_Trajectory_AOI_ArrayFiltered = [];
  var trajectoryPointIndex = 0;
  let trajetoriaArray = [];
  var totalTraj = 0;
  var aisAOI_trajSelected = [];
  var g_cluster_df = [];  // 10 set
  var gridCell_array = [];
  var flagLegendExist = false; 
  var flag_Environment_Legend_Exist = false; // 14 Ago
  var flag_Optimization_Legend_Exist = false; // 14 Ago  

  var global_df_ClusterColorTable = []; 
  var perc_pointsNotMatch = 0.0; 
  var df_ClusterTotalMatch = [];
  var df_clustering = [];    // added 17 set

  var firstShowAboutPage_flag = true;
  var flag_active_back_end_process = false;  //////////// novo 19jul
  var flag_runing_js_function = false;  /////// novo 24jul
  var flag_trajectory_analysis = false; // added 05 ago
  var array_classifications = []; // added 24 ago
  

  const fileInput = document.getElementById('aoi_File'); // 22jul
 // const fileInput_historical_AIS = document.getElementById('inputFile_historical_AIS'); // 28 ago   // removed  17set
  const fileInput_filter_AOI_from_AIS = document.getElementById('id_filter_AOI'); // 29 ago
  const fileInput_concat_filtered_files = document.getElementById('id_concat_filtered_files'); // 29 ago
  const fileInput_load_filtered_historical_AIS = document.getElementById('inputFile_load_filtered_historical_AIS'); //03 set
  const fileInput_load_filtered_trajectory_AIS = document.getElementById('inputFile_load_filtered_trajectory_AIS'); //10 set
  const fileInput_load_filtered_historical_AIS_and_clustered = document.getElementById('inputFile_load_filtered_historical_AIS_and_clustering'); //03 set
  
  const btnRadioNormal_getElement = document.getElementById('btnSelectNormal'); // added 25 ago
  const btnRadioAnomalous_getElement = document.getElementById('btnSelectAnomalous');
  const btn_chk_recover_getElement = document.getElementById('btn_chk_recover');  // added 17 set
  var flag_stop_button_active = false; // added 26 ago
  var b_apply_clustering = "1"; // true added 17 set

  exibe_Blank_WindRose(); // show a blank WindRose at first time
  exibeAboutPage();
  
  //////////////////////////////////////////////////////////////////////////////
                                    // FUNCTIONS //
  //////////////////////////////////////////////////////////////////////////////

  function save_clustering(){
    if (g_cluster_df.length > 0) {
        //define the heading for each row of the data  
        var csv = 'MMSI,LAT,LON,SOG,GridCell,xm,ym,Clus_Db\n';
          
        //merge the data with CSV  
        g_cluster_df.forEach(function(row) {  
                csv += row.join(',');  
                csv += "\n";  
        });  
        //polygon_CSV = csv;
        //display the created CSV data on the web browser
        //document.write(csv);  
        var hiddenElement = document.createElement('a');  
        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);  
        hiddenElement.target = '_blank';  
          
        //provide the name for the CSV file to be downloaded  
        hiddenElement.download = 'Save_Clustering.csv';  
        hiddenElement.click(); 
        
    } else {alert("It would have at least one register to save the clustering into a file.")}; 
    
  }
  /**
  function recover_clustering_btn(){
    
    //selectAIS_File();
    var btn = document.getElementById("btnApply");
    btn.disabled = false;
    highlight_element_HMI_button("btnPlot", "clustering"); // 02 ago
    highlight_element_HMI_button("", "btnApply");
    flag_trajectory_analysis = true; // 05 ago
    
    b_apply_clustering = "0";

  } **/

  function geracaoBINs(speed_str, course_str){
    
    var speedBIN = 0;
    let vCourse = ['0N','1NE', '1NE', '2E','2E', '3SE', '3SE', '4S', '4S', '5SW', '5SW', '6W', '6W','7NW','7NW', '0N'];
    //if course < 0: # novo 23Mar
    //    course = course + 360  #for negative values
    speed = parseFloat(speed_str);
    //console.log("speed = ", speed);
    course = parseFloat(course_str);
    
    var course_Positive = (course + 360) % 360; // convert to positive values if necessary

    var index = parseInt(course_Positive / 22.5); // each cardinal and colateral point has a segment of 45 degrees (2 x 22.5)
    
    let courseBIN = vCourse[index];
    
    if (speed <= 3){
        speedBIN = 3; // "0-3"
    }else if (speed <= 7){
        speedBIN = 7; // "3-7"
    }else if (speed <= 11){
        speedBIN = 11; //"7-11"
    }else if (speed <= 15){
        speedBIN = 15; //"11-15"
    }else if (speed <= 20){
        speedBIN = 20; // "15-20"
    }else{ 
        speedBIN = 99; // "20+"
    }
    //console.log("speedBIN = ", speedBIN);
    return [speedBIN, courseBIN];
  }

  function file_AIS_select_dialog(){

    if (flagGridCreation == false){
      alert("It must have a Grid created.");
      return;
    }
    var file_select_dialog = document.getElementById("id_filter_AOI");
    file_select_dialog.click();
  }
  function concat_AIS_Files_v2(){
    
    var file_select_dialog = document.getElementById("id_concat_filtered_files");
    file_select_dialog.click();
  }
  
  // Simple JavaScript Promise that reads a file as text.
  function readFileAsText(file){
    return new Promise(function(resolve,reject){
        let fr = new FileReader();

        fr.onload = function(){
            resolve(fr.result);
        };

        fr.onerror = function(){
            reject(fr);
        };

        fr.readAsText(file);
    });
  }

  function filter_AOI_from_AIS_file(){
    alert("This action could take several minutes.");
    exibeAlertMsg(); //not working
    var fileSize = 0;
    var theFile = document.getElementById("id_filter_AOI");
    //var theFile = document.getElementById("id_filter_AOI").files;//
    var filename_ais_historical = theFile.files[0].name;
    //var filename_ais_historical = theFile[0].name;//
    console.log("nome do arquivo = ", filename_ais_historical);
    let data_row_AIS = [];
    let data_to_save_into_file = [];
    var valid_lat_lon = false;
    //var speedBIN = "";
    //var courseBIN = "";
    let additional_fields = []; //["999", "999", "0", "0"];/////
    //additional_fields[0] = additional_fields[0].split(",");///
         
    if (typeof (FileReader) != "undefined") { //check if browser support FileReader
    
      var myReader = new FileReader(); // file reader object
      myReader.onload = function(e) {  //get file contents, split them by line
          
          let data = myReader.result.split("\n");
          data.shift(); // remove first element - the header // removed teste 05 set
          data.pop(); // remove last element - blank array
          for (let i in data) { //loop each row split them by "," and save it in array
            data[i] = data[i].split(",");
            data_row_AIS[i] = data[i];
            
            valid_lat_lon = is_belong_AOI(data_row_AIS[i][2], data_row_AIS[i][3]);  //lat, long
            if (valid_lat_lon == true){
              const [speedBIN, courseBIN] = geracaoBINs(data_row_AIS[i][4], data_row_AIS[i][5]);
              //additional_fields = [speedBIN, courseBIN, '0', '0'];///
              
              data_row_AIS[i].splice(16, 1,); // remove field  transceiver class
              data_row_AIS[i].splice(13, 2);  // remove fields width and draft
              data_row_AIS[i].splice(11, 1);  // remove field status
              data_row_AIS[i].splice(6, 4, '0', '0', courseBIN, speedBIN); //remove fields heading,
                                                                          // vesselName, IMO, CallSign

              //data_row_AIS[i] = [...additional_fields,...data_row_AIS[i]];// ok ///////////
              data_to_save_into_file.push(data_row_AIS[i]);
            }
          }
          console.log("ais_historical AOI filtered = ", data_to_save_into_file);//
          console.log("antes do save");
          save_AIS_historical_data_filtered_to_file(data_to_save_into_file, filename_ais_historical);
          fechaAlertMsg();//////////////////////////
          console.log("depois do save");
      }
      myReader.readAsText(theFile.files[0]);  //call file reader onload
    }
    else {
        alert("This browser does not support FileReader - HTML5.");
    }
    ////////
    var total_files = theFile.files.length;
    console.log("numero de arqs = ", total_files);
    
    //////////
    return false;   
  }
  
  function concat_file_from_AIS_filtered(){
    
    alert("This action could take several minutes.");
    exibeAlertMsg(); //not working
    let readers = [];
    let data_temp = "";// myReader.result.split("\n");
    
    var theFiles = document.getElementById("id_concat_filtered_files").files;//
    total_files = theFiles.length;
          
    for(let i = 0;i < total_files;i++){
      readers.push(readFileAsText(theFiles[i]));
    }
    var csv_concat_files = "";  
    var csv = 'MMSI,BaseDateTime,LAT,LON,SOG,COG,TrajID,GridCell,courseBIN,speedBIN,VesselType,Length,Cargo\n';
    // Trigger Promises
    Promise.all(readers).then((values) => {
        // ["File1 Content", "File2 Content" ... "FileN Content"]
        console.log(values);
        for(let i = 0;i < total_files;i++){
          var file_contents = values[i].split('\n');
          file_contents.shift();
          file_contents.forEach(function(row) {  
              csv_concat_files += row + "\n";  
          }); 
          //csv_concat_files = csv_concat_files + values[i];  // works
        }
        csv_concat_files = csv + csv_concat_files;

        var hiddenElement = document.createElement('a');  
        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv_concat_files);  
        hiddenElement.target = '_blank';  
          
        //provide the name for the CSV file to be downloaded  
        hiddenElement.download = 'concated_files_data_filtered_AOI_';  
        hiddenElement.click(); 
    });
    fechaAlertMsg();
  }

  function is_belong_AOI(latitude, longitude){

    var lat = parseFloat(latitude);
    var lon = parseFloat(longitude);

    var lonInf = parseFloat(lonInfGrid);
    var lonSup = parseFloat(lonSupGrid);
    var latInf  = parseFloat(latInfGrid);
    var latSup  = parseFloat(latSupGrid);
    
    if (lon < lonInf || lon < -180.0){
      return false;
    }
    if (lon > lonSup || lon > 180.0){
      return false;
    }
    if (lat < latInf || lat < -90.0){
      return false;
    }
    if (lat > latSup || lat > 90.0){
      return false;
    } 
    if (isPointInPolygon(latitude, longitude, pontos) == false){
      return false;
    } else{
      return true;
    }
  }
  
  function btn_chk_recover_select(){

    //var anomalous_selectType = document.getElementById("btn_chk_recover");
    
    if ( btn_chk_recover_getElement.checked == true){
      console.log("botao check true");
      var element = document.getElementById("clustering");
      element.disabled = true;
      element = document.getElementById("btn_save_clustering");
      element.disabled = true;
      element = document.getElementById("btn_recover_clustering");
      element.disabled = false;
    }
    else {
      console.log("botao check false");
      var element = document.getElementById("clustering");
      element.disabled = false;
      element.click();  // added 25set
      element = document.getElementById("btn_save_clustering");
      element.disabled = false;
      element = document.getElementById("btn_recover_clustering");
      element.disabled = true;
      
    }
  }

  function btnRadioNormal_select(){
    var anomalous_selectType = document.getElementById("anomalous_type");
    if (btnRadioNormal_getElement.checked == true){
      anomalous_selectType.disabled = true;
    } 
  }

  function btnRadioAnomalous_select(){ // 25 ago
    var anomalous_selectType = document.getElementById("anomalous_type");
    if (btnRadioAnomalous_getElement.checked == true){
      anomalous_selectType.disabled = false;
    }
  }
  
  fileInput.addEventListener('change', event => { // 22Jul
    loadArea2();
  });
  ////////////// 28 ago
  /**  removed 17 set
  fileInput_historical_AIS.addEventListener('change', event => { // 22Jul
    send_AIS_historical_file();
  });**/

  fileInput_filter_AOI_from_AIS.addEventListener('change', event => { // 29 ago
    
    filter_AOI_from_AIS_file();
  });
  
  fileInput_concat_filtered_files.addEventListener('change', event => { // 29 ago
    concat_file_from_AIS_filtered();
  });

  fileInput_load_filtered_historical_AIS.addEventListener('change', event => { // 03 set
    load_filtered_historical_AIS_file();
  });
///////////////////////// 17 set
  fileInput_load_filtered_historical_AIS_and_clustered.addEventListener('change', event => { // 03 set
    load_filtered_historical_AIS_file_and_clustered();
  });
//////////////////////////////////////

  ////////// 10 set
  fileInput_load_filtered_trajectory_AIS.addEventListener('change', event => { // 03 set
    load_filtered_trajectory_AIS_file();
  });

  /////// fim 10 set


  /////////////// set 17
  function recover_clustering(){
    var file_select_dialog = document.getElementById("inputFile_load_filtered_historical_AIS_and_clustering");
    file_select_dialog.click();
  }
  function load_filtered_historical_AIS_file_and_clustered(){
    
    let data_row_clustering = [];
    //let data_to_save_into_file = [];
    var theFile = document.getElementById("inputFile_load_filtered_historical_AIS_and_clustering").files[0];//
    let data = readFileAsText(theFile);
    data.then((values) => {
      let data_file = values.split("\n");
      data_file.shift(); // added 06 set  00h47 tira o header
      data_file.pop();   // added 06 set  00h58 tira o ultimo
      for (let i in data_file) { //loop each row split them by "," and save it in array
            data_file[i] = data_file[i].split(",");
            data_row_clustering[i] = data_file[i];
	          //data_to_save_into_file.push(data_row_AIS[i]);
            df_clustering.push(data_row_clustering[i]);
      }
      console.log("data_file_clustering = ", df_clustering);
      //openFileAIS(theFile.name);
      
    });
    b_apply_clustering = "0"; // added 17 set
    show_Parameters_labels_inputs(true, false, false, "File: " + theFile.name, "", "", 0, "", 0);////
  }

  ////////////////

  ////////////////////////////////// 03 set/////////////////
  function selectAIS_File(){
  
    var file_select_dialog = document.getElementById("inputFile_load_filtered_historical_AIS");
    file_select_dialog.click();
  }
  function load_filtered_historical_AIS_file(){
    
    let data_row_AIS = [];
    let data_to_save_into_file = [];
    var theFile = document.getElementById("inputFile_load_filtered_historical_AIS").files[0];//
    let data = readFileAsText(theFile);
    data.then((values) => {
      let data_file = values.split("\n");
      data_file.shift(); // added 06 set  00h47 tira o header
      data_file.pop();   // added 06 set  00h58 tira o ultimo
      for (let i in data_file) { //loop each row split them by "," and save it in array
            data_file[i] = data_file[i].split(",");
            data_row_AIS[i] = data_file[i];
	          //data_to_save_into_file.push(data_row_AIS[i]);
            ais_Historical_AOI_ArrayFiltered.push(data_row_AIS[i]);
      }
      console.log("data_file = ", ais_Historical_AOI_ArrayFiltered);
      openFileAIS(theFile.name);
      
    });
  }


  var input_User = document.getElementById("inputTxtName");
  input_User.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      document.getElementById("btn_fechaLogin").click();
    }
  });
  
  var input_Password = document.getElementById("inputTxtPassword");
  input_Password.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      document.getElementById("btn_fechaLogin").click();
    }
  });

  function restart_app(){
    location.reload(); 
  }
  function close_restart_page(){
    modalRestart.close();
  }
  
  function highlight_element_HMI(normal, highlight){

    var elemento = document.getElementById("btn_Map_Set_View");
    elemento.style.color = "white" ;

    elemento = document.getElementById("btn_AOI");
    elemento.style.color = "white" ;

    elemento = document.getElementById("btn_Grid_Creation");
    elemento.style.color = "white" ;

    elemento = document.getElementById("btn_Trajectory_Data");
    elemento.style.color = "white" ;

    if (highlight != ""){
      elemento = document.getElementById(highlight);
      elemento.style.color = "#e71d89";//
    }
  }

  function highlight_element_HMI_subMenu(normal, highlight){

    //var elemento = document.getElementById("removeArea");
    //elemento.style.Color = "rgb(68, 41, 83)";

    //elemento = document.getElementById("select_AOI_File");
    //elemento.style.color = "rgb(68, 41, 83)";

    //$("#select_AOI_File").removeClass(".subnav-content a");
    //$("#select_AOI_File").addClass(".subnav-content a");
    
    /*
    elemento = document.getElementById("geraAOI");
    elemento.style.color = "rgb(68, 41, 83)";    
    elemento = document.getElementById("saveAOI");
    elemento.style.color = "rgb(68, 41, 83)";    
    elemento = document.getElementById("subButton_enable_AIS_File");
    elemento.style.color = "rgb(68, 41, 83)";    
    elemento = document.getElementById("concat_Files");
    elemento.style.color = "rgb(68, 41, 83)";   
    elemento = document.getElementById("downloadClassification");
    elemento.style.color = "rgb(68, 41, 83)";  
    */
    if (highlight != ""){
      elemento = document.getElementById(highlight);
      elemento.style.color = "#e71d89";//
    } else {
      elemento = document.getElementById(normal);
      elemento.style.color = "white";//
      $("#subButton_enable_AIS_File").removeClass(".subnav-content");
      $("#subButton_enable_AIS_File").addClass(".subnav-content");

    }
  }
  
  function highlight_element_HMI_button(normal, highlight){
    
    if (normal != ""){
      var elemento = document.getElementById(normal); // 02 Ago
      //elemento.style.backgroundColor = "inherit"; //"LightGrey";
      elemento.style.color = "black";
    }
    if (highlight != ""){
      var elemento = document.getElementById(highlight); // 02 Ago
      //elemento.style.backgroundColor = "black";
      elemento.style.color = "#e71d89"; // 
    }

  }

  function GetSelectedClusteringValue(clustering) {
    var selText = clustering.options[clustering.selectedIndex].innerHTML;
    var selIndex = clustering.value;
        
    var labelParam1 = ""
    var labelParam2 = ""
    var labelParam3 = ""
    
    switch(selIndex) {
      case "1":  // Automatic Mode 30 jul // Original None (Density plots only)
        //labelParam1 = "Auto settings for an Ensemble Clustering";
        show_Parameters_labels_inputs(false, false, false, "", 0, "", 0, "", 0 )
        break;

      case "2": // Agglomerative Clustering
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "3": //BIRCH
        labelParam1 = "Threshold:";
        labelParam2 = "n_clusters:";
        show_Parameters_labels_inputs(true, true, false, labelParam1, 0.1, labelParam2, 18, "", 0)
        break;

      case "4": // DBSCAN LAT, LON
      case "5": // DBSCAN LAT, LON, SPEED
        labelParam1 = "eps:";
        labelParam2 = "Min Pts:";
        show_Parameters_labels_inputs(true, true, false, labelParam1, 0.04, labelParam2, 18, "", 0)
        break;

      case "6": //HDBSCAN
        labelParam1 = "eps:";
        labelParam2 = "min_samples:";
        labelParam3 = "min_cluster_size:";
        show_Parameters_labels_inputs(true, true, true, labelParam1, 0.04, labelParam2, 18, labelParam3, 20)
        break;

      case "7":  // K-Means
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "8": // Mean Shift
        labelParam1 = "Bandwidth:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 1, "", 0, "", 0)
        break;

      case "9": // Mini-Batch K-Means
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "10": //Mixture of Gaussians
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "11": // OPTICS
        labelParam1 = "eps:";
        labelParam2 = "min_samples:";
        show_Parameters_labels_inputs(true, true, false, labelParam1, 0.04, labelParam2, 18, "", 0)
        break;

      case "12": // Spectral Clustering
        labelParam1 = "n_clusters:";
        show_Parameters_labels_inputs(true, false, false, labelParam1, 18, "", 0, "", 0)
        break;

      case "13": //KMeans Ensemble
        labelParam1 = "n_Kmeans:";
        labelParam2 = "Min_Probability:";
        labelParam3 = "n_clusters:";
        show_Parameters_labels_inputs(true, true, true, labelParam1, 16, labelParam2, 0.6, labelParam3, 18)
        break;

      case "14": // Ensemble Clusters
        labelParam1 = "n_Kmeans:";
        labelParam2 = "n_clusters:";
        show_Parameters_labels_inputs(true, true, false, labelParam1, 16, labelParam2, 18, "", 0)
        break;
      
      default:
        // code block
    } 
  }

  function show_Parameters_labels_inputs(p1, p2, p3, label_P1, value_P1, label_P2, value_P2, label_P3, value_P3){
    
    var labelParameter1 = document.getElementById("lbl_inputParameter1");
    var labelParameter2 = document.getElementById("lbl_inputParameter2");
    var labelParameter3 = document.getElementById("lbl_inputParameter3");

    var value_inputParameter1 = $('#inputParameter1');
    var value_inputParameter2 = $('#inputParameter2');
    var value_inputParameter3 = $('#inputParameter3');

    if (p3){
      labelParameter3.innerHTML = label_P3;
      $("#inputParameter3").removeClass("not-visible");
      $("#inputParameter3").addClass("visible");
      value_inputParameter3.val(value_P3);

    } else{
      labelParameter3.innerHTML = "";
      $("#inputParameter3").removeClass("visible");
      $("#inputParameter3").addClass("not-visible");
    }
    if (p2){
      labelParameter2.innerHTML = label_P2;
      $("#inputParameter2").removeClass("not-visible");
      $("#inputParameter2").addClass("visible");
      value_inputParameter2.val(value_P2);
    } else{
      labelParameter2.innerHTML = "";
      $("#inputParameter2").removeClass("visible");
      $("#inputParameter2").addClass("not-visible");
    }
    if (p1){
      labelParameter1.innerHTML = label_P1
      $("#inputParameter1").removeClass("not-visible");
      $("#inputParameter1").addClass("visible");
      value_inputParameter1.val(value_P1);
    } else{
      labelParameter1.innerHTML = "";
      $("#inputParameter1").removeClass("visible");
      $("#inputParameter1").addClass("not-visible");
    }
    if (!(p1 || p2 || p3)){
      labelParameter1.innerHTML = "Auto settings for an Ensemble Clustering"
    }
  }

  function newMarker(e){
    if (flagPolygon == true){ // 22 jul
      return;
    } 
    //var new_mark = L.marker().setLatLng(e.latlng).addTo(mapa);
    var new_mark;
    //new_mark = L.marker().setLatLng(e.latlng).addTo(mapa);
    new_mark = new L.marker().setLatLng(e.latlng).addTo(mapa);
    new_mark.addTo(markersLayerGroup); 
    mapa.addLayer(markersLayerGroup); 

    new_mark.dragging.disable();//enable
    new_mark.on('dblclick', function(e){ 
    //  console.log(e.target);
        var latUltPonto = pontos[pontos.length - 1][0];
        var lonUltPonto = pontos[pontos.length - 1][1]; 
        //console.log(latUltPonto,lonUltPonto);
        if ((latUltPonto == e.latlng.lat.toFixed(5)) && (lonUltPonto == e.latlng.lng.toFixed(5))){
          mapa.removeLayer(new_mark);//(e.target);
          pontos.pop();
        };
    })
    var lat = e.latlng.lat.toFixed(5), lng = e.latlng.lng.toFixed(5);
    new_mark.bindPopup("Latitude: " + lat + "</br>" + "Longitude: "+ lng);
		//console.log(lat, lng);
		pontos.push([lat, lng]);
		//console.table(pontos);
		new_mark.on('dragend', function(e) {  //precisa habilitar o dragging
		       new_mark.bindPopup("Latitude: " + lat + "</br>"+ "Longitude: "+ lng) // 
        });

		//valida conteudo do input 
    if (pontos.length > 2) {
          //habilita o boto
          //  document.getElementById("geraAOI").disabled = false;
          //  document.getElementById("salvaCoordAOI").disabled = false;
    } else {
              //desabilita o boto se o contedo do input ficar em branco
          //  document.getElementById("geraAOI").disabled = true;
          //  document.getElementById("salvaCoordAOI").disabled = false;
    };
	};
  mapa.on('click', newMarker);	    	

	function gerarPoligono(){
		if (pontos.length > 2) {
      if (flagPolygon == true){
        mapa.removeLayer(polygon);
        flagPolygon = false;
      };
      polygon = L.polygon(pontos, {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
              ).addTo(mapa);
          console.table(pontos);
      mapa.removeLayer(markersLayerGroup);
      
      highlight_element_HMI("btn_Map_Set_View", "");  // 02 ago
      highlight_element_HMI("btn_AOI", "btn_Grid_Creation"); // 02 Ago
      flagPolygon = true;
    }
    else {
      if (flagPolygon == true){
        mapa.removeLayer(polygon);
        flagPolygon = false;
      };
      alert("To create a polygon it would have at least three locations in the map.")
    };  
  }
		
	function centralizarMapa(local){
    
    var localZoom = local;
    if (localZoom == 1){
      mapa.setView([-14, -38], 4);
      //mapaAIS.setView([-14, -38], 3);
    }
    if (localZoom == 2){
      mapa.setView([39, -73], 4);
      //mapaAIS.setView([39, -73], 3);
    }
		if (localZoom == 3){
      mapa.setView([0, 0], 4);
      //mapaAIS.setView([3, 5], 3);
    }
    if (localZoom == 4){
      mapa.setView([-24, 112], 4);
      //mapaAIS.setView([-24, 112], 3);
    }
    if (localZoom == 5){
      mapa.setView([45, 0], 4);
      //mapaAIS.setView([45, 0], 3);
    }
    
    highlight_element_HMI("btn_Map_Set_View", "btn_AOI"); //added 05 ago
  };

  function removeArea(){
    if (flag_trajectory_analysis){
      modalRestart.showModal();
      return;
      //location.reload();
    }
        
    if (flagPolygon == true){
      mapa.removeLayer(markersLayerGroup); 
      markersLayerGroup.clearLayers();
      while (pontos.length) { //remove all the elements inside the array
        pontos.pop(); 
      }
      mapa.removeLayer(polygon);
      flagPolygon = false;
      
      if (flagGridCreation == true){
          mapa.removeLayer(cellsLayerGroup);
          mapa.removeLayer(polylinha); // added 05 ago
          cellsLayerGroup.clearLayers(); //

          flagGridCreation = false;
      }
      highlight_element_HMI("btn_Grid_Creation", "btn_AOI"); // 02 ago

    } else {
      alert("There is no area to be removed.")
    }
  }
  
  function select_AOI_File(){

    var AOI_File = document.getElementById("aoi_File");
    AOI_File.click();
    //retorno = AOI_File.click();
    //console.log("retorno do AOI_File.click = ",retorno);
  }
  
  function loadArea2(){

    //var AOI_File = document.getElementById("aoi_File");
    //AOI_File.click();

    var fileSize = 0;
    var theFile = document.getElementById("aoi_File");
    //theFile.click();
    var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
    //var data_CSV = new array;
    if (regex.test(theFile.value.toLowerCase())) {  //check if file is CSV
     
        if (typeof (FileReader) != "undefined") { //check if browser support FileReader
        
          var myReader = new FileReader(); // file reader object
          myReader.onload = function(e) {  //get file contents, split them by line
              
              let data = myReader.result.split("\n");
              for (let i in data) { //loop each row split them by "," and save it in array
                data[i] = data[i].split(",");
              }
              data.shift(); // remove first element - the header
              data.pop(); // remove last element - blank array
              //console.log(data);
              plotLoadedArea(data);
              //return data; // teste
              
          }
          myReader.readAsText(theFile.files[0]);  //call file reader onload
          highlight_element_HMI("btn_Map_Set_View", "");  // 02 ago
          highlight_element_HMI("btn_AOI", "btn_Grid_Creation"); // 02 Ago
        }
        else {
           alert("This browser does not support HTML5.");
        }
    }
    else {
           alert("Please upload a valid CSV file.");
    }
    //console.log(data);
    return false;    //plotLoadedArea(data2);
  }
  
  function loadArea(){
    //loadArea2(); // novo 11jul
    //alert("parada no comando loadArea"); //
    $.ajax({
            url: "{{ url_for('loadFileAOI') }}",
            type: "GET",
            dataType: 'json',
            success: plotLoadedArea,
            error: function(){
              alert("erro execuo loadFileAOI no Back-end");
            }
            
        });
  }
  function plotLoadedArea(locations){
    //pontos = locations;
    if (locations == "") {
      return;
    }
    
    if (flagPolygon == true){
      removeArea();
    }
    //console.log("locations 0 = ",locations[0]); //
    //pontos = JSON.parse(locations); //novo 12jul
    pontos = locations.map(function (obj){
      return obj;
    }); //novo 12 jul
    //console.log("locations from back end = ", pontos); // novo 11jul
    var csv = 'LAT,LONG\n';  
          
    //merge the data with CSV  
    pontos.forEach(function(row) {  
            csv += row.join(',');  
            csv += "\n";  
    });  
    polygon_CSV = csv;
    //console.log("polygon_CSV = ", polygon_CSV);

    const [latInfAOI, latSupAOI, lonInfAOI, lonSupAOI, latMedAOI] = findMinMax(pontos);
    gerarPoligono();
    mapa.setView([latMedAOI, (lonInfAOI + lonSupAOI)/2], 8);
    ///////// jul22
    //mapaAIS.setView([latMedAOI, (lonInfAOI + lonSupAOI)/2], 7);  // added 22jul //removed 30jul
  }
   //create a user-defined function to download CSV file   
  function download_csv_file() {  
    //console.log("locations pontos dentro da funcao download = ", pontos); // novo 12jul
    if (pontos.length > 2) {
        //define the heading for each row of the data  
        var csv = 'LAT,LONG\n';  
          
        //merge the data with CSV  
        pontos.forEach(function(row) {  
                csv += row.join(',');  
                csv += "\n";  
        });  
        polygon_CSV = csv;
        //display the created CSV data on the web browser
        //document.write(csv);  
        var hiddenElement = document.createElement('a');  
        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);  
        hiddenElement.target = '_blank';  
          
        //provide the name for the CSV file to be downloaded  
        hiddenElement.download = 'LatLongAOI.csv';  
        hiddenElement.click(); 
        
    } else {alert("It would have at least three locations in the map to save these.")}; 

  }
  ////////////////// novo 24 ago /////////////////////////////
  function download_classifications() {  
    
    if (array_classifications.length > 0) {
        //define the heading for each row of the data  
        //var csv = ""; //'LAT,LONG\n';  
        var csv = 'UserName, nameFile_historical_AIS, nameFile_traj_AIS, trajectoryID, clustering, typeTraj, anomalous_type,strDate,strTime\n';
          
        //merge the data with CSV  
        array_classifications.forEach(function(row) {  
                csv += row.join(',');  
                csv += "\n";  
        });  
        
        var hiddenElement = document.createElement('a');  
        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);  
        hiddenElement.target = '_blank';  
          
        //provide the name for the CSV file to be downloaded  
        hiddenElement.download = 'classifications.csv';  
        hiddenElement.click(); 
        
    } else {alert("It would have at least one classification to make downloads.")}; 

  }
  function save_AIS_historical_data_filtered_to_file(array_data_AIS_to_file, filename){
    if (array_data_AIS_to_file.length > 0) {
        
        arr = array_data_AIS_to_file.sort(function (a, b) { // sort by MMSI and BaseDateTime
                  return a[0].localeCompare(b[0]) || a[1].localeCompare(b[1]);
        });
        //define the header for each row of the data  
        var csv = 'MMSI,BaseDateTime,LAT,LON,SOG,COG,TrajID,GridCell,courseBIN,speedBIN,VesselType,Length,Cargo\n';
        //var csv = "";  // without header
        //merge the data with CSV  
        arr.forEach(function(row) {  
                csv += row.join(',');  
                csv += "\n";  
        });  
        
        var hiddenElement = document.createElement('a');  
        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);  
        hiddenElement.target = '_blank';  
          
        //provide the name for the CSV file to be downloaded  
        hiddenElement.download = 'historical_data_filtered_AOI_' + filename;  
        hiddenElement.click(); 
        /////////////
        //arr = array_data_AIS_to_file.sort(function (a, b) {
        //        return a[0].localeCompare(b[0]) || a[1].localeCompare(b[1]);
        //    });
        console.log("arr = \n", arr);

        
    } else {alert("The filtered array of AIS data is empty and couldn't be saved into a file.")}; 
  }

  ///////////////////////////////////////////
  function excluirUltPonto(){
      //  console.log(e.target);
      var latUltPonto = pontos[pontos.length - 1][0];
      var lonUltPonto = pontos[pontos.length - 1][1]; 
      //console.log(latUltPonto,lonUltPonto);
      //if ((latUltPonto == e.latlng.lat.toFixed(5)) && (lonUltPonto == e.latlng.lng.toFixed(5))){
       //       mapa.removeLayer(e.target);
          //    pontos.pop();
      //};
      //mapa.removeLayer(polygon);
  }
  function setSizeCell(size){
    cellSize = size;
    
    //gridCreation(); // original 06 Ago
    /////////  teste
    (async () => {
      let response = await gridCreation();
      await response; ///gridCreation;
      //let user = await response; ///gridCreation;
    
    })();
    /////////////
  }  

  function gridCreation(){
    exibeAlertMsg();
    alert("The Grid construction takes a few seconds depending on the area size");
    
    if (flagPolygon == true){
        
        const [latInfAOI, latSupAOI, lonInfAOI, lonSupAOI, latMedAOI] = findMinMax(pontos);
        latInfGrid = latInfAOI; 
        latSupGrid = latSupAOI;
        lonInfGrid = lonInfAOI;
        lonSupGrid = lonSupAOI;
        
        //console.log("AOI pontos = ", latInfAOI, latSupAOI, lonInfAOI, lonSupAOI, latMedAOI);
        var pontoA = [latInfAOI, lonInfAOI];
        var pontoB = [latSupAOI, lonInfAOI];
        var pontoC = [latSupAOI, lonSupAOI];
        var pontoD = [latInfAOI, lonSupAOI];
        var coordGrid = [pontoA, pontoB, pontoC, pontoD, pontoA];

        if (flagGridCreation == true){
          mapa.removeLayer(markersLayerGroup);
          mapa.removeLayer(cellsLayerGroup);
          cellsLayerGroup.clearLayers(); 
          mapa.removeLayer(polylinha); 
          //flagGridCreation = false;  ////////jul22
        }
        
        exibirAreaLimGrid(coordGrid);
        
        [qtdeCel_X, qtdeCel_Y, larguraCelula, alturaCelula] = calculaGridParametros(latInfAOI, latMedAOI, latSupAOI, lonInfAOI, lonSupAOI, cellSize);
        var total_cells = qtdeCel_X * qtdeCel_Y;
        if (total_cells < 22500){
        
          for (var j = 0; j < qtdeCel_Y; j++) {
            for (var k = 0; k < qtdeCel_X; k++) {   
                
              vertA_Cel = [parseFloat(latInfAOI + j * alturaCelula)      ,parseFloat(lonInfAOI + k * larguraCelula)];
              vertB_Cel = [parseFloat(latInfAOI + (j + 1) * alturaCelula),parseFloat(lonInfAOI + k * larguraCelula)];
              vertC_Cel = [parseFloat(latInfAOI + (j + 1) * alturaCelula),parseFloat(lonInfAOI + (k + 1)* larguraCelula)];
              vertD_Cel = [parseFloat(latInfAOI + j * alturaCelula)      ,parseFloat(lonInfAOI + (k + 1)* larguraCelula)];
              vertices  = [vertA_Cel, vertB_Cel, vertC_Cel, vertD_Cel];
              if (isPointInPolygon(vertA_Cel[0],vertA_Cel[1], pontos) ||
                  isPointInPolygon(vertB_Cel[0],vertB_Cel[1], pontos) ||
                  isPointInPolygon(vertC_Cel[0],vertC_Cel[1], pontos) ||
                  isPointInPolygon(vertD_Cel[0],vertD_Cel[1], pontos)){
                //polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "green", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
                //).addTo(mapa);
                polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "green", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
                ).addTo(cellsLayerGroup);
              }
              else {
                //polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "gray", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "black", "fillOpacity": 0.5, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
                //).addTo(mapa);
                polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "gray", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "black", "fillOpacity": 0.5, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
                ).addTo(cellsLayerGroup);
              }
            }
          }   
          
          mapa.addLayer(cellsLayerGroup); 
          //highlight_element_HMI("btn_Grid_Creation", "btn_Trajectory_Data"); // 02 ago // realocated 05ago
          //flagGridCreation = true;
          alert("The Grid has been created with " + total_cells + " cells");
        } else{
          alert("The Grid has been created with " + total_cells + " cells, but to avoid overloading in the MAP the Grid visualization has been limited to 22.500 cells. ");
        }
        highlight_element_HMI("btn_Grid_Creation", "btn_Trajectory_Data"); // 05 ago
        //highlight_element_HMI_subMenu("", "subButton_enable_AIS_File"); // added 05 ago); 
        flagGridCreation = true;
    } else {
      alert("To create a Grid it would have an Area of Interest.")};
      fechaAlertMsg();
  }  
  function exibirAreaLimGrid(pontosGrid){
       
    polylinha = L.polyline(pontosGrid, {"bubblingMouseEvents": true, "color": "blue", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
                    ).addTo(mapa);
  }
  function enable_AIS_File_btn(){

    if (flagGridCreation == true){
      var btn = document.getElementById("btnSelectAIS_File");
      btn.disabled = false;  
      
      var card = document.getElementById("aisData"); // 30 jul // alter 02 Ago 
      card.style.opacity = 1.0; // 30 jul
      
      highlight_element_HMI("btn_Trajectory_Data", "");
      //highlight_element_HMI_subMenu("subButton_enable_AIS_File", ""); // added 05ago
      highlight_element_HMI_button("", "btnSelectAIS_File");

    }
    else {
      alert("It must have a Grid created.")
    }
  }

  function btnClassifAnomaly(){
    //saveClassificationFile();
    saveClassificationFile_browser(); // added 25 ago
  }
  
  function exibeInfo_Msg(){
    modalInfo.showModal();
  }
  function fechaInfo_Msg(){
    modalInfo.close()
    highlight_element_HMI("", "btn_Map_Set_View"); // 03 ago
  }

  function exibeAlertMsg(){
    flag_active_back_end_process = false; ////novo 19jul
    //modalAlert.showModal();
    //document.body.appendChild(document.getElementById('AlertMsg'));///
    modalAlert.showModal();
  }
  function fechaAlertMsg(){
    flag_active_back_end_process = true; ////novo 19jul
    modalAlert.close();
  }
  
  function exibeAboutPage(){
    modalAbout.showModal();
  }
  function fechaAboutPage(){
    modalAbout.close()
    if (firstShowAboutPage_flag == true){
      exibeLoginPage();
    }
    firstShowAboutPage_flag = false;
  }

  function exibeLoginPage(){
    modalLogin.showModal();
  }
  function fechaLoginPage(){
    
    expertID = document.getElementById("inputTxtName").value;
    expertPassword = document.getElementById("inputTxtPassword").value;
    var dado = JSON.stringify([expertID, expertPassword]); // 22 jul
    
    //console.log("nome do expert e senha = ", expertID, expertPassword);
    $.ajax({
            url: "{{ url_for('checkLoginName') }}",
            type: "POST",
            dataType: 'json',
            contentType: 'application/json',
            data: dado,
            success: validaLogin,
            error: function(){
              alert("erro execuo login no Back-end");
            }
        });
  }
  function validaLogin(retorno){

    expertFileName = retorno;
    
    if (expertFileName == 'none') {
      //console.log("valor none");
      alert("The name, password or both are unknown. Please try again.");
    } else {
      modalLogin.close();
      exibeInfo_Msg(); // 03 ago
    }
  }
  function loadExpertFile(){
    $.ajax({
            url: "{{ url_for('loadExpertFile') }}",
            type: "GET",
            dataType: 'json',
            success: function(retorno){ 
              alert("Arquivo de classificao carregado"); /// 23 jul
            },
            error: function(){
              alert("error execution loadExpertFile no back-end");
            }
    });
  }
  ////////////////////////////// novo 24 Ago /////////////////
  function saveClassificationFile_browser(){

    const d = new Date();

    var nameFile_historical_AIS = document.getElementById("inputTxtFileName").value; /// 22 jul
    var nameFile_traj_AIS = document.getElementById("inputDataSetsFileName").value; /// 22 jul

    let strDate = d.toLocaleDateString();
    let strTime = d.toLocaleTimeString();

    var typeTraj = ""
    var trajetoria = document.getElementById("listBoxTrajectories").value;
    var clustering = document.getElementById("clustering").value;

    var confidence = document.getElementById("confidence").value;
    var normalState  = document.getElementById("btnSelectNormal");
    var anomalous_type = document.getElementById("anomalous_type").value;
    
    if (normalState.checked){
        typeTraj = "normal";
        anomalous_type = "not aplicable";
    } else {
        typeTraj = "anomalous"
    }
    var classification_row = [expertID, nameFile_historical_AIS, nameFile_traj_AIS, trajetoria, clustering, 
                                typeTraj, anomalous_type,strDate,strTime];
    console.log("classification_row = ", classification_row);
    array_classifications.push(classification_row);
    console.log("array_classifications = ", array_classifications);
    alert("The classification has been stored in memory. Use the <Export> button to export all the classifications to a local file.");
    
  }

  function saveClassificationFile(){

    ////////// added 24 ago 
    saveClassificationFile_browser();

    const d = new Date();

    var nameFile_historical_AIS = document.getElementById("inputTxtFileName").value; /// 22 jul
    var nameFile_traj_AIS = document.getElementById("inputDataSetsFileName").value; /// 22 jul

    let strDate = d.toLocaleDateString();
    let strTime = d.toLocaleTimeString();
    
    var typeTraj = ""
    var trajetoria = document.getElementById("listBoxTrajectories").value;
    var clustering = document.getElementById("clustering").value;
    
    var confidence = document.getElementById("confidence").value;
    var normalState  = document.getElementById("btnSelectNormal");
    if (normalState.checked){
        typeTraj = "normal"
    } else {
        typeTraj = "anomalous"
    }

    var dados = JSON.stringify([nameFile_historical_AIS, nameFile_traj_AIS, trajetoria, clustering, 
                                typeTraj, confidence,strDate,strTime]);
    //console.log("dados do post saveClassification = ", dados);
    
    $.ajax({
            url: "{{ url_for('saveClassification') }}",
            type: "POST",
            dataType: 'json',
            contentType: 'application/json',
            data: dados,
            success: function(retorno){ 
              alert("Arquivo de classificao salvo");
            },
            error: function(){
              alert("error execution saveClassification no back-end");
            }
    });
  
  }
  
  function exibeInstructions(){
    modalInstructions.showModal();
    modalInstructions.scrollTo(0,0);
  }
  function fechaInstructions(){
    modalInstructions.close()
  }
 
  function async_selectAIS_File(){  
    (async () => {
      let response = await selectAIS_File();
      await response; ///gridCreation;
      //let user = await response; ///gridCreation;
    
    })();
  }
   ///////////////////// 28 ago /////////////////
  /**
  function async_selectAIS_File_NEW(){
    var AIS_historical_file = document.getElementById("inputFile_historical_AIS");
    AIS_historical_file.click();
  }**/

  /**
  function send_AIS_historical_file(){

    var dados = JSON.stringify([latInfGrid, latSupGrid, lonInfGrid, lonSupGrid,
                             polygon_CSV, larguraCelula, alturaCelula, qtdeCel_X]);

    let uploadedFile = document.getElementById('inputFile_historical_AIS').files;//.files[0];
         var form_data = new FormData();

         len = uploadedFile.length;
         for (var i=0; i<len; i++){
          form_data.append(uploadedFile[i].name, uploadedFile[i]);
         }
         form_data.append("latInfGrid",latInfGrid);
         form_data.append("latSupGrid", latSupGrid);
         form_data.append("polygon_CSV", polygon_CSV);
         form_data.append("alturaCelula", alturaCelula);

         //form_data.append("historical_file2",uploadedFile[1]);////
         
         $.ajax({
            url: "{{ url_for('selectAIS_File2') }}",
            method: "POST",
            processData: false,
            contentType: false,
            //dataType: 'multipart/form-data',
            data: form_data,
            success: function(){
              alert("Success send AIS historical file");
              //alert("filename dentro do ajax = ", retorno);
            },
            error: function(){
              alert("error execution send AIS historical file");
            }
         });
  }**/
  
  function openFileAIS(filename_historical_file){
    
    var textField = $('#inputTxtFileName');
    textField.disabled = false;

    textField.val(filename_historical_file); 
    
    pathHistoricalFileAISdata = filename_historical_file; // novo 13jul // added 03 set
    
    var btn = document.getElementById("btnPlot");
    btn.disabled = false;
    highlight_element_HMI_button("btnSelectAIS_File", "btnPlot"); // 02 ago
  }
 
  ///////////////////  03 set /////////////////////

  function apply_vessels_filter(){

    //////////// codigo para o filtro
    
    //////////////
    var MMSI_previous = parseInt(ais_Historical_AOI_ArrayFiltered[0][0]);
    var MMSI_actual = 999999999;
    var lat_vessel = 0;
    var lon_vessel = 0;
    
    var id_TrajID = 1 ;

    var len = ais_Historical_AOI_ArrayFiltered.length;
    console.log("iniciando a funcao apply_vessels_filters - length do ais_hist = ", len);
    for (var i=0; i<len; i++){
        
        MMSI_actual = parseInt(ais_Historical_AOI_ArrayFiltered[i][0]);
                            
        if (MMSI_previous != MMSI_actual){
            MMSI_previous = MMSI_actual;
            id_TrajID = id_TrajID + 1;
        };
        ais_Historical_AOI_ArrayFiltered[i][6] = id_TrajID;
        lat_vessel = parseFloat(ais_Historical_AOI_ArrayFiltered[i][2]);
        lon_vessel = parseFloat(ais_Historical_AOI_ArrayFiltered[i][3]);

        ais_Historical_AOI_ArrayFiltered[i][7] = GridNavio2(lat_vessel,lon_vessel, latInfGrid, lonInfGrid, larguraCelula, alturaCelula, qtdeCel_X); //gridCell
    }
  }

  function aisPlotFile(){
    alert("This action may be extended for one or more minutes after closing this message. At the end another message will inform the status.");  
    exibeAlertMsg();
    
    $("#aisPlotPanel").removeClass("not-visible");
    $("#aisPlotPanel").addClass("visible");

    const [latInfAOI, latSupAOI, lonInfAOI, lonSupAOI, latMedAOI] = findMinMax(pontos);
    //b_apply_clustering = "1"; // true  added 17 set
    AISplotPanel();
    //plotAisDataPanel();
  }
  ///////////////////////////////// 03 set //////////////////
  function AISplotPanel(){
     ////////////////////// novo TESTE
    //plotAisDataPanel(0);
    //////////////////
    var form_data_rosewind = new FormData();

    var csv_ais_Historical = 'MMSI,BaseDateTime,LAT,LON,SOG,COG,TrajID,GridCell,courseBIN,speedBIN,VesselType,Length,Cargo\n'; 
          
        //merge the data with CSV  
    ais_Historical_AOI_ArrayFiltered.forEach(function(row) {  
      csv_ais_Historical += row.join(',');  
      csv_ais_Historical += "\n";  
    }); 
    form_data_rosewind.append("ais_Historical_AOI_ArrayFiltered", csv_ais_Historical);

    $.ajax({
      url: "{{ url_for('openHistoricalFileAndFilterAOI') }}",
      type: "POST",
      processData: false,
      contentType: false,
      //dataType: 'multipart/form-data',
      data: form_data_rosewind,
      success: plotAisDataPanel,
      error: function(){
        fechaAlertMsg();
        alert("erro execuo Post para Open File");
      }
    });
  }

  function plotAisDataPanel(retorno){
    
    //console.log(retorno);
    //var ret = JSON.parse(retorno[0]); // historical AIS data ????

    /////////// corrigir //////////
    gridCell_array = JSON.parse(retorno); //[1]); 
    console.log("gridCell_array = \n", gridCell_array);
    ////////////////////////////
    let vet = ais_Historical_AOI_ArrayFiltered; // added 04 set
    
    //var len = ret.length;
    var len = vet.length;
    console.log("plotAisDataPanel - length of ais_Historical_AOI_ArrayFiltered = ", len);

    if (len > 0){
      mapa.removeLayer(markersLayerGroup); 
      mapa.removeLayer(cellsLayerGroup);
      
      //flagGridCreation = false;  /// jul22
      
      for (var i = 0; i < len; i++) {
          //console.log("primeiros lat e long = ", vet[i][2], " ", vet[i][3]);
          //console.log("primeiros lat e long com parseFloat = ", parseFloat(vet[i][2]), parseFloat(vet[i][3]));
          //ais_Historical_AOI_ArrayFiltered.push(ret[i]); // removed 04 set

          var circle = L.circle([vet[i][2], vet[i][3]], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 30
          //}).addTo(mapaAIS); // removed 30 jul
          }).addTo(mapa);       // added 30 jul
      }  
      fechaAlertMsg(); 
      alert("The plotting processing has been done."); 
      var btn = document.getElementById("clustering");
      btn.disabled = false;
      
      btn = document.getElementById("inputParameter1");
      btn.disabled = false;
      btn = document.getElementById("inputParameter2");
      btn.disabled = false;
      btn = document.getElementById("inputParameter3"); // novo 25Jun23
      btn.disabled = false;

      btn = document.getElementById("btnApply");
      btn.disabled = false;
      highlight_element_HMI_button("btnPlot", "clustering"); // 02 ago
      highlight_element_HMI_button("", "btnApply");
      flag_trajectory_analysis = true; // 05 ago

    } else {
      alert("arquivo selecionado no possui dados de AIS no Grid/AOI selecionada");
    } 
    console.log("tamanho ais_Historical_AOI_ArrayFiltered = ", ais_Historical_AOI_ArrayFiltered.length);
    //console.log(ais_Historical_AOI_ArrayFiltered);
    fechaAlertMsg(); //////////////// novo 19jul
  }
  
  function enableTrajectoryPanel(){
   
    var btn = document.getElementById("listBoxTrajectories");
    btn.disabled = false;
    btn = document.getElementById("btnPrevious");
    btn.disabled = true; //jul22
    btn = document.getElementById("btnNext");
    btn.disabled = false;
    
    //loadExpertFile(); // jul 23
  }
  function classificationWindow(){
   
    var btn = document.getElementById("classificationPanel");
    btn.disabled = false;
    //btn = document.getElementById("btnFinish"); novo 29Jun
    //btn.disabled = false;
    
    $("#aisPlotPanel").removeClass("visible");
    $("#aisPlotPanel").addClass("not-visible");
    
    $("#AISpointGridPanel").removeClass("not-visible"); 
    $("#AISpointGridPanel").addClass("visible");

    $("#windRosePanel").removeClass("not-visible");
    $("#windRosePanel").addClass("visible");
  }

  function async_applyClustering(){

    (async () => {
      //b_apply_clustering = "1"; // ture
      let response = await applyClustering(b_apply_clustering);
      await response; 
        
    })();
  }
  
  async function applyClustering(bool_apply_clustering){ // 08 ago
    
    var listBoxClustering = document.getElementById("clustering");
    idClustering = parseInt(listBoxClustering.value);
    
    var param1 = document.getElementById("inputParameter1").value;
    var param2 = document.getElementById("inputParameter2").value;
    var param3 = document.getElementById("inputParameter3").value; // novo 25Jun

    //var b_apply_clustering = document.getElementById("XXXXXX").value; //
    //var dados = JSON.stringify([idClustering, latInfGrid, latSupGrid, lonInfGrid, lonSupGrid, param1, param2, param3]);
    
    ///////// teste 09 set
    var form_data_clustering = new FormData();

    form_data_clustering.append("idClustering",idClustering);
    form_data_clustering.append("latSupGrid"  ,latSupGrid);
    form_data_clustering.append("latInfGrid"  ,latInfGrid);
    form_data_clustering.append("lonSupGrid"  ,lonSupGrid);
    form_data_clustering.append("lonInfGrid"  ,lonInfGrid);
    
    form_data_clustering.append("param1" , param1);
    form_data_clustering.append("param2" , param2);
    form_data_clustering.append("param3" , param3);
    
    form_data_clustering.append("flag_recover_clustering", bool_apply_clustering);

    /////////////////
    csv_ais_Historical = "";
    if (bool_apply_clustering == "1"){
      var csv_ais_Historical = 'MMSI,BaseDateTime,LAT,LON,SOG,COG,TrajID,GridCell,courseBIN,speedBIN,VesselType,Length,Cargo\n'; 
      ais_Historical_AOI_ArrayFiltered.forEach(function(row) {  
        csv_ais_Historical += row.join(',');  
        csv_ais_Historical += "\n";  
      });  
    } else {
      var csv_ais_Historical = 'MMSI,LAT,LON,SOG,GridCell,xm,ym,Clus_Db\n'; 
      df_clustering.forEach(function(row) {  
        csv_ais_Historical += row.join(',');  
        csv_ais_Historical += "\n";  
      }); 

    }  
    
    form_data_clustering.append("ais_Historical_AOI_ArrayFiltered", csv_ais_Historical);
        
    var len = ais_Historical_AOI_ArrayFiltered.length;
    if (len == 0){
      alert("Botao apply - arquivo selecionado no possui dados de AIS no Grid/AOI selecionada");
      return;
    }  
    alert("Starting the clustering process.");
    exibeAlertMsg(); 
    
    ///////////////////////////////////////////////////
    $.ajax({
      url: "{{ url_for('applyClustering') }}",
      type: "POST",
      processData: false,
      contentType: false,
      //dataType: 'multipart/form-data',
      data: form_data_clustering,
      success: plot_Clustering_LatLon,
      error: function(){
        fechaAlertMsg();
        alert("erro execuo Post para applyClustering");
      }
    });
    enableTrajectoryPanel();
    console.log("passou no ajax applyClustering");
    //fechaAlertMsg(); // 06 ago
  }

  function exec_applyClustering(dados){

    $.ajax({
      url: "{{ url_for('applyClustering') }}",
      type: "POST",
      dataType: 'json',
      contentType: 'application/json',
      data: dados,
      success: plot_Clustering_LatLon,
      error: function(){
        fechaAlertMsg();
        alert("erro execuo Post para applyClustering");
      }
    });
  }

  function applyNoneClustering(length){

    for (var i = 0; i < length; i++) {
      
      var circle = L.circle([ais_Historical_AOI_ArrayFiltered[i][2], ais_Historical_AOI_ArrayFiltered[i][3]], {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5,
        radius: 50
      }).addTo(mapa);
    } 
  }
  
  function plot_Clustering_LatLon(retorno){
    //console.log(retorno);
    console.log("passou no success - plot_Clustering");
    var df_Clusters_LatLon = JSON.parse(retorno[0]); 
    var df_ClusterColorTable  = JSON.parse(retorno[1]); 
    console.log("df_Clusters_LatLon = \n", df_Clusters_LatLon);
    console.log("df_ClusterColorTable = \n", df_ClusterColorTable);

    lenGlobal = df_ClusterColorTable.length;
    while (global_df_ClusterColorTable.length) { //remove all the elements inside the array
      global_df_ClusterColorTable.pop(); 
    }
    for (index=0; index < lenGlobal; index++){
      global_df_ClusterColorTable.push(df_ClusterColorTable[index]); // make a global copy
    }

    //////////////////
    lenGlobal = df_Clusters_LatLon.length;
    while (g_cluster_df.length) { //remove all the elements inside the array
      g_cluster_df.pop(); 
    }
    for (index=0; index < lenGlobal; index++){
      g_cluster_df.push(df_Clusters_LatLon[index]); // make a global copy
    }
    
    ///////////////

    var len = df_Clusters_LatLon.length;
    var clusterColor = "";
    var numCluster = 0;
    var opacity_value = 0.5;  // default value

    if (len > 0){
      mapa.removeLayer(markersLayerGroup); 
      mapa.removeLayer(cellsLayerGroup);
      
      for (var i = 0; i < len; i++) {
     
          numCluster = parseInt(df_Clusters_LatLon[i][7]); 
        
          if (numCluster == -1){
            clusterColor = '#000000';
            opacity_value = 1;
          } else{
            clusterColor = df_ClusterColorTable[numCluster][1];
            opacity_value = 0.5;
          }
          
          var circle = L.circle([df_Clusters_LatLon[i][1], df_Clusters_LatLon[i][2]], {
            color: clusterColor,
            fillColor: clusterColor,//'#f03',
            fillOpacity: opacity_value,
            radius: 30
          }).addTo(mapa);
      }  
      fechaAlertMsg(); 
      alert("The Clustering plotting processing has been done."); 

      var element = document.getElementById("trajectory"); // 02 Ago
      element.style.opacity = 1.0; // 02 Ago

      var btn = document.getElementById("btnLoadDatasets_File");
      btn.disabled = false;
      highlight_element_HMI_button("clustering", ""); // 02 ago
      highlight_element_HMI_button("btnApply", "btnLoadDatasets_File");
    } else {
      alert("erro na execuo function plot_Clustering_LatLon");
    } 
    console.log("tamanho df_Clusters_LatLon = ", df_Clusters_LatLon.length);
    //console.log(df_Clusters_LatLon);
  }


  function async_showTrajectory(){
    exibeAlertMsg();///
    (async () => {
      let response = await showTrajectory();
      await response; 
    
    })();
    fechaAlertMsg();//
  }

  async function showTrajectory(){ //
    //exibeAlertMsg(); //26 jul
    if (flagLegendExist == true){ /// 26 jul
      mapa.removeControl(legend);///////
    }

    var listBoxTraj = document.getElementById("listBoxTrajectories");
    idTrajetory = listBoxTraj.value;
    len = ais_Trajectory_AOI_ArrayFiltered.length;

    while (aisAOI_trajSelected.length) { //remove all the elements inside the array
      aisAOI_trajSelected.pop(); 
    }
    
    for (index=0; index < len; index++){

      //if (count_idTrajetory <= idTrajetory){
        if (idTrajetory == ais_Trajectory_AOI_ArrayFiltered[index][6]){ // 20
          aisAOI_trajSelected.push(ais_Trajectory_AOI_ArrayFiltered[index]);
        }

      //}
    }
    console.log("tamanho do aisAOI-trajSelected = ", aisAOI_trajSelected.length);
    console.log("antes de chamar classificationWindow");
    //plotSelectedTrajectory();  // novo 29Jun
    classificationWindow();
    trajectoryPointIndex = 0; /// 24 jul
    flag_runing_js_function = true;
    plotSelectedTrajectory(); // novo 29Jun
    
    //trajectoryPointIndex = 0; // 24 jul
    setTimeout(drawGridCell(trajectoryPointIndex), 2000); // show the first AIS point of the trajectory
    get_PercentageMatchCells();   //// 25 jul

    //var i = 0;
    //while (flag_runing_js_function = true){
    //  console.log("running js function - nr times = ", i);
    //  i = i + 1;
    //}
    //fechaAlertMsg(); // 30 jul
    alert("The selected trajectory has been plotting with yellow circle marks."); // 30 jul
    ///// original setTimeout(displayMapLegend(idTrajetory), 4000); // 25jul
    //displayMapLegend(idTrajetory); // 24jul 
    var btn = document.getElementById("btnPlay_trajectory"); // 31 jul
    btn.disabled = false;   // 31 jul

    var card = document.getElementById("cardInferior"); // 30 jul
    card.style.opacity = 1.0; // 30 jul
    highlight_element_HMI_button("listBoxTrajectories", ""); // 02 ago
    highlight_element_HMI_button("btnShow", "btnShow_panel_matching_cells");
    highlight_element_HMI_button("", "btnPlay_trajectory");
    highlight_element_HMI_button("", "btnNext");
  
  }

  function show_panel_matching_cells(){  //// 25 jul
    exibeAlertMsg(); // 26 jul
    var listBoxTraj = document.getElementById("listBoxTrajectories");
    idTrajetory = listBoxTraj.value;
    displayMapLegend(idTrajetory); 

    var btn = document.getElementById("btnShow_panel_matching_cells");
    btn.disabled = true;
    highlight_element_HMI_button("btnShow_panel_matching_cells", ""); // 02 ago
  }
  
  function plotSelectedTrajectory(){

    var len = aisAOI_trajSelected.length;
    if (len > 0){
      
      btn = document.getElementById("btnPrevious");  //// 22 jul
      btn.disabled = true;   // 22jul
      mapa.removeLayer(trajectoryLayerGroup); 
      trajectoryLayerGroup.clearLayers();
      mapa.removeLayer(displayedPointsLayerGroup); 
      displayedPointsLayerGroup.clearLayers();

      for (var i = 0; i < len; i++) {
        
          var circle = L.circle([aisAOI_trajSelected[i][2], aisAOI_trajSelected[i][3]], {
            color: 'yellow',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 50
          }).addTo(trajectoryLayerGroup) 
        
      }  
      mapa.addLayer(trajectoryLayerGroup); 

      var element = document.getElementById("AISpointGridPanel"); // 02 Ago
      element.style.opacity = 1.0; // 02 Ago

      element = document.getElementById("windRosePanel"); // 02 Ago
      element.style.opacity = 1.0; // 02 Ago
      //////// 14 Ago
      var listBoxTraj = document.getElementById("listBoxTrajectories");
      idTrajetory = listBoxTraj.value;
      displayEnvironmentLegend(""); // 14 Ago //id buoy
      displayOptimizationLegend(idTrajetory); // 14 Ago
    } else {
      alert("The trajectory selected is empty");
    }
    
    flag_runing_js_function = false; //// 24 jul
  }
  
  function drawGridCell(index){
    
    mapa.removeLayer(polygonCell); 
    
    var lat  = aisAOI_trajSelected[index][2];
    var long = aisAOI_trajSelected[index][3];
    var circle = L.circle([lat, long], {color: 'blue', fillColor: '#f03', fillOpacity: 0.5, radius: 50
          }).addTo(displayedPointsLayerGroup); 
    mapa.addLayer(displayedPointsLayerGroup); 
    vertices = calcVerticesCell(lat, long, latInfGrid, lonInfGrid, larguraCelula, alturaCelula); 
    polygonCell = L.polygon(vertices, {"bubblingMouseEvents": true, "color": "blue", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", 			"noClip": false, "opacity": 1.0, "smoothFactor": 1.0, "stroke": true, "weight": 1}
                  ).addTo(mapa);

    var textFieldSpeed = $('#inputTxtSpeed');
    textFieldSpeed.disabled = false;
    textFieldSpeed.val(aisAOI_trajSelected[index][4]);
    var bg = document.getElementById("inputTxtSpeed");
    bg.style.color = "black";      //"green"; 
    
    var cardinalLetter = aisAOI_trajSelected[index][8];             //[19]; 
    var gridCellNumber = aisAOI_trajSelected[index][7];        //[21];
    
    var textFieldCourse = $('#inputTxtCourse');
    textFieldCourse.disabled = false;
    textFieldCourse.val(aisAOI_trajSelected[index][5] + " " + cardinalLetter);
    console.log("MMSI = ", aisAOI_trajSelected[index][0], " Course = ", aisAOI_trajSelected[index][5], " Cell = ", gridCellNumber);

    // windrose data
    const [s3_array, s7_array, s11_array, s15_array, s20_array, s99_array] = buildWindRose_array(gridCellNumber);
    exibeWindRose(s3_array, s7_array, s11_array, s15_array, s20_array, s99_array); 
    //display_windRose_on_MAP(); // 10 ago
    //exibeWindRose_on_MAP(s3_array, s7_array, s11_array, s15_array, s20_array, s99_array); // 10 Ago TESTE
  }

  function display_windRose_on_MAP(){   // SEM USO //// 13 Ago
    
    /*Legend specific*/
    //if (flagLegendExist == true){
    //  mapa.removeControl(legend);///////
    //}
    windRose_Legend = L.control({ position: "bottomright" }); 

    windRose_Legend.onAdd = function(mapa) {
      var div = L.DomUtil.create("div", "vesselsSpeed_on_MAP");
      return div;
    };
    windRose_Legend.addTo(mapa);
  };


  function buildWindRose_array(gridCellID){
    //gridCell_array
    var s3  = [0, 0, 0, 0, 0, 0, 0, 0];
    var s7  = [0, 0, 0, 0, 0, 0, 0, 0];
    var s11 = [0, 0, 0, 0, 0, 0, 0, 0];
    var s15 = [0, 0, 0, 0, 0, 0, 0, 0];
    var s20 = [0, 0, 0, 0, 0, 0, 0, 0];
    var s99 = [0, 0, 0, 0, 0, 0, 0, 0];
    var index = 0;
    var speedBIN = 0;
    var freq = "";

    var len = gridCell_array.length;
    for (index = 0; index < len; index++) {
      if (gridCellID == gridCell_array[index][0]){
        break;
      }
    }
    for (; index < len; index++) {
      if (gridCellID == gridCell_array[index][0]){
        
        courseBIN_number = parseInt(gridCell_array[index][1].charAt(0));
        speedBIN = gridCell_array[index][2];
        freq = gridCell_array[index][3];

        if (speedBIN == 3){
          s3[courseBIN_number] = freq;
        }
        if (speedBIN == 7){
          s7[courseBIN_number] = freq;
        }
        if (speedBIN == 11){
          s11[courseBIN_number] = freq;
        }
        if (speedBIN == 15){
          s15[courseBIN_number] = freq;
        }
        if (speedBIN == 20){
          s20[courseBIN_number] = freq;
        }
        if (speedBIN == 99){
          s99[courseBIN_number] = freq;
        }
      }else {
        break;
      }
    }
    //console.log ("windRose arrays = \n", s3, "\n", s7, "\n", s11, "\n", s15, "\n", s20, "\n",s99);
    return [s3, s7, s11, s15, s20, s99];
  }

  function btnPrevious(){
    if (trajectoryPointIndex > 0){

      /////////// 22 jul
      var circle = L.circle([aisAOI_trajSelected[trajectoryPointIndex][2],
                             aisAOI_trajSelected[trajectoryPointIndex][3]], {
            color: 'yellow',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 50
          }).addTo(displayedPointsLayerGroup) 
      mapa.addLayer(displayedPointsLayerGroup); 
      
      trajectoryPointIndex = trajectoryPointIndex - 1;
      drawGridCell(trajectoryPointIndex);
      ////////// 22 jul
      btn = document.getElementById("btnNext");
      btn.disabled = false;
      if (trajectoryPointIndex == 0){
        btn = document.getElementById("btnPrevious");
        btn.disabled = true;
      }
    }
    
  }

  function btnNext(){
    if (trajectoryPointIndex < aisAOI_trajSelected.length -1){
      trajectoryPointIndex = trajectoryPointIndex + 1;
      drawGridCell(trajectoryPointIndex);
      
      btn = document.getElementById("btnPrevious");
      btn.disabled = false;
      
      if (trajectoryPointIndex == aisAOI_trajSelected.length -1){
        btn = document.getElementById("btnNext");
        btn.disabled = true;
      }
      highlight_element_HMI_button("btnNext", "");  //02 ago
    } 
  }
  function play_trajectory(){
    var btnStop = document.getElementById("btnStop_Play_trajectory");
    disable_btnPlay_trajectory(true); // added 26 ago 23h
    disable_btnPlot_trajectory(true);

    if (flag_stop_button_active == true){
      flag_stop_button_active = false; // added 26 ago
      disable_btnPlay_trajectory(false); // added 26 ago 23h
      disable_btnPlot_trajectory(false);
      return
    }
    btnStop.disabled = false;
    if (trajectoryPointIndex != aisAOI_trajSelected.length -1){
      btnNext();
      setTimeout(play_trajectory, 300); 
    } else {
      var btn = document.getElementById("btnPrevious");
      btn.disabled = true;
      btn = document.getElementById("btnNext");
      btn.disabled = false;
      
      plotSelectedTrajectory(); // add 05 ago
      trajectoryPointIndex = 0; // add 05 ago
      drawGridCell(trajectoryPointIndex); // 05 ago
      flag_stop_button_active = false; // added 26 ago
      btnStop.disabled = true; //added 26 ago
      disable_btnPlay_trajectory(false); // added 26 ago 23h
      disable_btnPlot_trajectory(false);
      return
    }  
    highlight_element_HMI_button("btnPlay_trajectory", "");  // 02 ago
    
  }
  function disable_btnPlay_trajectory(boolean){
      var btn = document.getElementById("btnPlay_trajectory");
      btn.disabled = boolean;
  }
  function disable_btnPlot_trajectory(boolean){
      var btn = document.getElementById("btnShow");
      btn.disabled = boolean;
  }
  
  function stop_play_trajectory(){
    var btn = document.getElementById("btnStop_Play_trajectory");
    btn.disabled = true;
    flag_stop_button_active = true;
  }

  function async_selectDatasetFile(){
    (async () => {
      let response = await selectDatasetFile();
      await response; 
    
    })();
  }

  function selectDatasetFile(){
    /**
    $.ajax({
            url: "{{ url_for('selectDatasetFile') }}",
            type: "GET",
            dataType: 'json',
            success: openDatasetFile,
            error: function(){
              alert("error execution selection AIS File");
            }
    });
    **/
    var file_select_dialog = document.getElementById("inputFile_load_filtered_trajectory_AIS");
    file_select_dialog.click();
  }

  ///////////// 10set
  function load_filtered_trajectory_AIS_file(){
    
    let data_row_AIS = [];
    let data_to_save_into_file = [];
    var theFile = document.getElementById("inputFile_load_filtered_trajectory_AIS").files[0];//
    let data = readFileAsText(theFile);
    data.then((values) => {
      let data_file = values.split("\n");
      data_file.shift(); // added 06 set  00h47 tira o header
      data_file.pop();   // added 06 set  00h58 tira o ultimo
      for (let i in data_file) { //loop each row split them by "," and save it in array
            data_file[i] = data_file[i].split(",");
            data_row_AIS[i] = data_file[i];
	          //data_to_save_into_file.push(data_row_AIS[i]);
            ais_Trajectory_AOI_ArrayFiltered.push(data_row_AIS[i]);
      }
      console.log("dataset_file = ", ais_Trajectory_AOI_ArrayFiltered);
      openDatasetFile(theFile.name);
    });
  }
  /////////////

  function openDatasetFile(filename_trajectory_file){           //retorno){
    ////////////// novo 13jul
    retorno = filename_trajectory_file; //"data/AOI Delaware 09-05-23 Grid 2k.csv";
    //console.log(retorno);
    if (retorno == ""){
      return;
    }

    var textField = $('#inputDataSetsFileName');
    textField.disabled = false;

    //textField.val(retorno); novo 13jul
    textField.val(filename_trajectory_file); //"data/AOI Delaware 09-05-23 Grid 2k.csv");
    
    //pathDatasetFile = retorno; // novo 13jul
    pathDatasetFile = filename_trajectory_file; //"data/AOI Delaware 09-05-23 Grid 2k.csv";
    
    var btn = document.getElementById("btnLoadDataset");
    btn.disabled = false;
    highlight_element_HMI_button("btnLoadDatasets_File", "btnLoadDataset"); // 02ago
  }
  
  function async_loadDatasetFile(){

    (async () => {
      let response = await loadDatasetFile();
      await response; 
    
    })();
  }
  function loadDatasetFile(){
    alert("This action may be extended for one or more minutes after closing this message. At the end another message will inform the status.");  
    //exibeAlertMsg(); 
    /**
    var dados = JSON.stringify([latInfGrid, latSupGrid, lonInfGrid, lonSupGrid,
                                pathDatasetFile, polygon_CSV, larguraCelula, alturaCelula, qtdeCel_X]);
    //console.log("front varivel dados = ", dados);
    $.ajax({
      url: "{{ url_for('openTrajectoryFileAndFilterAOI') }}",
      type: "POST",
      dataType: 'json',
      contentType: 'application/json',
      data: dados,
      success: getArrayData_forTrajectories,
      error: function(){
        fechaAlertMsg();
        alert("erro execuo Post para Open Dataset File");
        
      }
    });
    **/
    //////////// codigo para o filtro


    //////////////
    var MMSI_previous = parseInt(ais_Trajectory_AOI_ArrayFiltered[0][0]);
    var MMSI_actual = 999999999;
    var lat_vessel = 0;
    var lon_vessel = 0;
    
    var id_TrajID = 1 ;

    var len = ais_Trajectory_AOI_ArrayFiltered.length;
    console.log("iniciando a funcao loadDatasetFile");
    for (var i=0; i<len; i++){
        
        MMSI_actual = parseInt(ais_Trajectory_AOI_ArrayFiltered[i][0]);
                            
        if (MMSI_previous != MMSI_actual){
            MMSI_previous = MMSI_actual;
            id_TrajID = id_TrajID + 1;
        };
        ais_Trajectory_AOI_ArrayFiltered[i][6] = id_TrajID;
        lat_vessel = parseFloat(ais_Trajectory_AOI_ArrayFiltered[i][2]);
        lon_vessel = parseFloat(ais_Trajectory_AOI_ArrayFiltered[i][3]);

        ais_Trajectory_AOI_ArrayFiltered[i][7] = GridNavio2(lat_vessel,lon_vessel, latInfGrid, lonInfGrid, larguraCelula, alturaCelula, qtdeCel_X); //gridCell
        //ais_Historical_AOI_ArrayFiltered[i][9] = gridCell;
    }
    getArrayData_forTrajectories(id_TrajID);

  }
  function getArrayData_forTrajectories(totalTraj){
    //console.log(retorno);
    //var ret = JSON.parse(retorno[0]); 
    //totalTraj = JSON.parse(retorno[1]); 
    console.log("total de traj = ", totalTraj);
    
    var len = ais_Trajectory_AOI_ArrayFiltered.length;
    
    if (len > 0){
            
      //for (var i = 0; i < len; i++) {
      //  ais_Trajectory_AOI_ArrayFiltered.push(ret[i]);
      //}  
      loadSelectBoxTrajectories(totalTraj);
      btn = document.getElementById("btnShow"); // novo 21Mai // realocado do final 02 ago
      btn.disabled = false;
      highlight_element_HMI_button("btnLoadDataset", "listBoxTrajectories"); //02 ago
      highlight_element_HMI_button("", "btnShow" ); //

      fechaAlertMsg();
      alert("The AIS data processing has been done."); 

      
    } else {
      fechaAlertMsg();
      alert("arquivo selecionado no possui dados de AIS no Grid/AOI selecionada");
    } 
    console.log("tamanho ais_Trajectory_AOI_ArrayFiltered = ", ais_Trajectory_AOI_ArrayFiltered.length);
    //console.log(ais_Trajectory_AOI_ArrayFiltered);
    
    
  }

  function downloadClassificationFile(){  // replaced by download_classifications()
  //  download_classifications(); 

    $.ajax({
            url: "{{ url_for('downloadClassification') }}",
            type: "GET",
            //dataType: 'json',
            success: function(retorno){ 
              if (retorno != ""){
                alert("Download finished, msg retorno = ", retorno);
              } else {alert("msg retorno no success = ", retorno)}
            },
            error: function(){
              alert("error execution downloadClassification in the back-end");
            }
    });

  }
  function loadSelectBoxTrajectories(total_traj) {
    var listBoxTraj = document.getElementById("listBoxTrajectories");
        
    for  (var k = 1; k <= total_traj; k++){ 
        var option = document.createElement("option");
        option.text = k;
        //console.log("option text = ", option.text);
        listBoxTraj.add(option);
    }
  }
  ///// Map Legend
  function displayMapLegend(id_traj){
    
    //alert("The Matching Cells calculation will be started.");//
    //exibeAlertMsg(); ///reposicionado 25jul
    var colorCluster = "";
    var percentage = 0;
    var idCluster = 0;
    
    /*Legend specific*/
    if (flagLegendExist == true){
      mapa.removeControl(legend);///////
    }
    legend = L.control({ position: "topright" }); 

    legend.onAdd = function(mapa) {
      var div = L.DomUtil.create("div", "legend");
      
      div.innerHTML += "<h4>Matching Cells</br>Trajectory " + id_traj + " x Clusters</h4>";
      
      console.log("df_ClusterTotalMatch.length = ", df_ClusterTotalMatch.length);
      console.log("perc_pointsNotMatch = ", perc_pointsNotMatch);

      for (var i=0; i < df_ClusterTotalMatch.length; i++){
        
        //colorCluster = global_df_ClusterColorTable[i][1];
        percentage = df_ClusterTotalMatch[i][2];
        idCluster = df_ClusterTotalMatch[i][0];
        
        if (percentage != 0 && idCluster != -1 ){ 
          colorCluster = global_df_ClusterColorTable[idCluster][1];
                    
          console.log("percentage = ", percentage);
          console.log("colorCluster = ", colorCluster);

          div.innerHTML += '<i style="background:' + colorCluster + '; width:' +
            parseInt(percentage*2) + 'px"></i>' + '(' + idCluster + ') ' + percentage + '%</br>';
            
        }
      }
      div.innerHTML += '<i style="background: #FFFFFF; width:' +
            parseInt(perc_pointsNotMatch*2) + 'px"></i>Not Match ' + perc_pointsNotMatch + '%</br>';

      div.innerHTML += "(Black dots are not clustered points)";
      //div.innerHTML += '<i style="background: #477AC2; width:100px"></i>50%</br>';
      //div.innerHTML += '<i style="background: #ffffff; width:60px"></i>30% Not Match';
      return div;

      //const myTimeout = setTimeout(get_PercentageMatchCells, 5000);// novo 16jul
      ////// original ////////setTimeout(get_PercentageMatchCells(), 0);/// jul24
      //get_PercentageMatchCells(); // jul 25
      //exibeAlertMsg(); ///novo 16jul
      ///////////////////////////////////////////////////
      //setTimeout(() => {
              //console.log("Hi, I am the console.log inside setTimeout 2sec")
          //},
          //2000
      //);
      
      /*
      /////////// sleep //////
      let currentTime = Date.now() / 1000;
      let expectedTime = currentTime + 2;
      while (currentTime < expectedTime) {
          currentTime = Date.now() / 1000;
      }
      /////////// fim sleep
      */

      //alert("The Matching Cells calculation has been started.");
      //////////////////////////////////////////////////////////////////
    };

    setTimeout(() => {legend.addTo(mapa)}, 3000);// jul 24
    //legend.addTo(mapa);   // jul 24 
    flagLegendExist = true;
    fechaAlertMsg(); // novo 16Jul 21jul
    //alert("The Matching Cells calculation has been done.");
    
  }
  //////////////////////////
  function displayEnvironmentLegend(id_traj){
    
    var xxxxx = "";
    var buoy_Id = "55";
    
    /*Legend specific*/
    if (flag_Environment_Legend_Exist == true){
      mapa.removeControl(Environment_Legend);///////
    }
    Environment_Legend = L.control({ position: "bottomright" }); 

    Environment_Legend.onAdd = function(mapa) {
      var div = L.DomUtil.create("div", "legend");
      
      div.innerHTML += "<h4>Environmental Data</br></h4>";
            
      div.innerHTML += "Wind Direction: " + '</br>';
      div.innerHTML += "Wind Speed: " + '</br>';
      div.innerHTML += "Wave Height: " + '</br>';
      div.innerHTML += "Source: Buoy " + buoy_Id;
           
      return div;

      //alert("The Matching Cells calculation has been started.");
      
    };

    setTimeout(() => {Environment_Legend.addTo(mapa)}, 1000);// jul 24
    //legend.addTo(mapa);   // jul 24 
    flag_Environment_Legend_Exist = true;
    //fechaAlertMsg(); // novo 16Jul 21jul
    //alert("The Matching Cells calculation has been done.");
    
  }
  ///////////////////////
  function displayOptimizationLegend(id_traj){
    
    var optimization_Percentage = "64";
        
    /*Legend specific*/
    if (flag_Optimization_Legend_Exist == true){
      mapa.removeControl(Optimization_Legend);///////
    }
    Optimization_Legend = L.control({ position: "bottomleft" }); 

    Optimization_Legend.onAdd = function(mapa) {
      var div = L.DomUtil.create("div", "legend");
      
      div.innerHTML += "<h4>Trajectory " + id_traj + '</br>Grid Cells Waypoints</h4>';
            
      div.innerHTML += "Cells: " + '</br>';
      div.innerHTML += "Total Distance: " + '</br>';
      div.innerHTML += "Travelled Distance: " + '</br>';
      div.innerHTML += "Optimization: " + '%';         //optimization_Percentage + '%';
           
      return div;
      //alert("The Matching Cells calculation has been started.");
    };

    setTimeout(() => {Optimization_Legend.addTo(mapa)}, 1000);// jul 24
    //legend.addTo(mapa);   // jul 24 
    flag_Optimization_Legend_Exist = true;
    //fechaAlertMsg(); // novo 16Jul 21jul
    //alert("The Matching Cells calculation has been done.");
  }
  
  function get_PercentageMatchCells(){
    console.log("js Tamanho aisAOI_trajSelected = ", aisAOI_trajSelected.length)
    //var dado = JSON.stringify(aisAOI_trajSelected);
    /////////////////////////////////////////////////////////
    var csv_g_cluster_df = 'MMSI,LAT,LON,SOG,GridCell,xm,ym,Clus_Db\n'; 
          
    //merge the data with CSV  
    g_cluster_df.forEach(function(row) {  
      csv_g_cluster_df += row.join(',');  
      csv_g_cluster_df += "\n";  
    });  

    ///////////////////////////////////////////////////////////////////////
    var dado = JSON.stringify([aisAOI_trajSelected, csv_g_cluster_df]);  

    $.ajax({
            url: "{{ url_for('calc_ClusterMatch') }}",
            type: "POST",
            dataType: 'json',
            contentType: 'application/json',
            data: dado,
            timeout: 10000, // novo 16jul
            success: get_PercentageMatch,
            error: function(xhr, textStatus, errorThrown) { //novo 16jul
              if (textStatus == 'timeout') {
                  alert("Error : Timeout 10s for calc_ClusterMatch call!");
              } else{
                  alert("erro execuo get_PercentageMatchCells function");
              }
            }
            //error: function(){
             // alert("erro execuo get_PercentageMatchCells function");
            //}
        });
  }
  function get_PercentageMatch(retorno){

    perc_pointsNotMatch  = JSON.parse(retorno[0]);
    df_ClusterTotalMatch = JSON.parse(retorno[1]);
    console.log("perc_pointsNotMatch = ", perc_pointsNotMatch);
    console.log("df_ClusterTotalMatch = \n", df_ClusterTotalMatch);
    
    var btn = document.getElementById("btnShow_panel_matching_cells"); // 25 jul
    btn.disabled = false;
    fechaAlertMsg(); // 26 jul
  }
  
  function concat_AIS_Files(){

    if (flagGridCreation == false){
      alert("It must have a Grid created.");
      return;
    }
    //jQuery.ajaxSetup({async:false}); // novo 04Jul
    exibeAlertMsg(); // novo 04Jul

    var dados = JSON.stringify([latInfGrid, latSupGrid, lonInfGrid, lonSupGrid,
                                polygon_CSV, larguraCelula, alturaCelula, qtdeCel_X]);
    //console.log("front varivel dados = ", dados);
    $.ajax({
      url: "{{ url_for('concat_AIS_Files') }}",
      type: "POST",
      dataType: 'json',
      contentType: 'application/json',
      data: dados,
      success: function(){
        alert("Ais Files concatenation has been done successfull");},
      error: function(){
        alert("error AIS Files concatenation");
      }
    });
    //jQuery.ajaxSetup({async:true}); // novo 04jul
    fechaAlertMsg(); // novo 4Jul
  }
  function checkBox_Auto_Function() {
    var checkBox = document.getElementById("checkBox_Auto");
    //var text = document.getElementById("text");
    if (checkBox.checked == true){
      //text.style.display = "block";
    } else {
      //text.style.display = "none";
    }
  }
  function performPost() {
        $.ajax({
            type: "POST",
            url: "{{ url_for('create_file') }}",
            data: {"name" : "Jim"},
        })
  }

</script>

</body>
</html>
